<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>My Memo</title>

    <script src="https://cdn.charles14.xyz/js/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.charles14.xyz/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.charles14.xyz/js/popper.min.js"></script>
    <script src="/js/general.js"></script>
    <script src="/js/table.js"></script>

    <link href="https://cdn.charles14.xyz/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.charles14.xyz/css/all.min.css" rel="stylesheet">

    <link href="https://cdn.charles14.xyz/noty/noty.css" rel="stylesheet">
    <script src="https://cdn.charles14.xyz/noty/noty.min.js" type="text/javascript"></script>
    <link href="https://cdn.charles14.xyz/noty/themes/mint.css" rel="stylesheet">
    <link href="/css/main.css" rel="stylesheet">

    <link rel="icon" href="/img/icon-sm.png">

    <script>
        var page = 1;
        var pageLimit = 10;
        var orderBy = "userId";
        var order = "asc";
        var search = "";
        var userList = [];

        function UpdateTable() {
            $("#refresh-btn").html('<i class="fa fa-sync fa-spin"></i>');
            $.ajax({
                url: "/api/admin/userList",
                method: 'POST',
                async: true,
                dataType: "json",
                data: {
                    page: page,
                    pageLimit: pageLimit,
                    orderBy: orderBy,
                    order: order,
                    search: search,
                    userId: localStorage.getItem("userId"),
                    token: localStorage.getItem("token"),
                },
                success: function (r) {
                    $("tbody tr").remove();
                    userList = r.data;
                    total = r.total;
                    totalUser = r.totalUser;

                    for (var i = 0; i < userList.length; i++) {
                        if (userList[i].userId < 0)
                            userList[i].userId = -userList[i].userId;
                        AppendTableData("userList", [userList[i].userId, userList[i].username,
                                userList[i].email, userList[i].inviter, userList[i]
                                .inviteCode, userList[i].age, userList[i].status, userList[
                                    i].privilege
                            ],
                            userList[i].userId.replaceAll("*", "P"));
                        userList[i].userId = userList[i].userId.replaceAll("*", "P");
                    }
                    l = (page - 1) * pageLimit + 1;
                    r = l + userList.length - 1;
                    if (userList.length == 0) {
                        AppendTableData("userList", ["No data available"], undefined,
                            "100%");
                        l = 0;
                    }

                    SetTableInfo("userList", "<p style='opacity:80%'>Showing " + l + " - " +
                        r + " / " + totalUser);
                    PaginateTable("userList", page, total, "UserListPage");

                    for (var i = 0; i < userList.length; i++) {
                        if (userList[i].status.indexOf("Active") != -1) {
                            if (localStorage.getItem("settings-theme") == "dark") {
                                $("#" + userList[i].userId).attr("style", "color:lightgreen");
                            } else {
                                $("#" + userList[i].userId).attr("style", "color:green");
                            }
                        }
                        if (userList[i].status.indexOf("Deleted") != -1) {
                            if (localStorage.getItem("settings-theme") == "dark") {
                                $("#" + userList[i].userId).attr("style", "color:lightgray");
                            } else {
                                $("#" + userList[i].userId).attr("style", "color:gray");
                            }
                        }
                        if (userList[i].status.indexOf("Pending Activation") != -1) {
                            if (localStorage.getItem("settings-theme") == "dark") {
                                $("#" + userList[i].userId).attr("style", "color:lightblue");
                            } else {
                                $("#" + userList[i].userId).attr("style", "color:blue");
                            }
                        }
                        if (userList[i].status.indexOf("Deactivated") != -1) {
                            if (localStorage.getItem("settings-theme") == "dark") {
                                $("#" + userList[i].userId).attr("style", "color:orange");
                            } else {
                                $("#" + userList[i].userId).attr("style", "color:orange");
                            }
                        }
                        if (userList[i].status.indexOf("Banned") != -1) {
                            $("#" + userList[i].userId).attr("style", "color:red");
                        }
                        if (userList[i].status.indexOf("Muted") != -1) {
                            $("#" + userList[i].userId).attr("style", "color:yellow");
                        }
                        if (userList[i].status.indexOf("Admin") != -1) {
                            $("#" + userList[i].userId).attr("style", "color:purple");
                        }
                    }
                    $("#refresh-btn").html('<i class="fa fa-sync"></i>');
                },
                error: function (r, textStatus, errorThrown) {
                    window.location.href = "/";
                }
            });
        }

        function UserListPage(p) {
            page = p;
            UpdateTable();
        }

        function Search() {
            search = $("#search-content").val();
            orderBy = "none";
            SortTable(orderBy);
            UpdateTable();
        }

        function UserListSort(id) {
            orderBy = id;
            if ($("#sorting_" + id).hasClass("sorting-desc")) {
                order = "desc";
            } else {
                order = "asc";
            }
            UpdateTable();
        }

        function UpdatePageLimit(pl) {
            if (pageLimit != pl) {
                page = Math.ceil((page - 1) * pageLimit / pl + 1);
                pageLimit = pl;
                UpdateTable();
            }
        }

        $(document).ready(function () {
            InitTable("userList", [10, 25, 50, 100], 10, UpdatePageLimit, Search);
            InitSorting("userList",
                ["userId", "username", "email", "inviter", "inviteCode", "age", "status", "privilege"],
                ["asc", undefined, undefined, undefined, undefined, undefined, undefined, undefined],
                "UserListSort");

            UpdateTable();

            $("#refresh-btn").click(function () {
                UpdateTable();
            });
        });
    </script>
</head>

<body>
    <div id="navigate" style="z-index:100">
        <div class="leftside">
            <div class="sqbtn">
                <a href="/"><img class="icon" src="/img/icon.png" style="width:2.2em;height:2.2em"></a>
            </div>
        </div>
        <div class="userctrl">
            <a href='/user'><i class="fa fa-user"></i></a> <span id="navusername"><a href='/user/login'>Sign
                    in</a>&nbsp;&nbsp; </span>
            <a class="only-signed-in" href='/notifications' style="display:none"><i
                    class="fa fa-bell"></i></a>
            <a href='/settings'><i class="fa fa-cogs"></i></a>
            <a class="only-signed-in" href='#' onclick="SignOut()" style="display:none"><i
                    class="fa fa-arrow-right-from-bracket"></i></a>
        </div>
    </div>
    <div id="content" class="container">
        <h1 class="title">User List&nbsp;&nbsp;<button type="button" class="btn btn-outline-secondary"
                id="refresh-btn"><i class="fa fa-sync"></i></button></h1>

        <div class="subcontainer sub-div">
            <table class="table table-hover" id="userList" style="text-align:center">
                <thead>
                    <tr>
                        <th id="table-userId" class="sorting">User ID</th>
                        <th id="table-username" class="sorting">Username</th>
                        <th id="table-email" class="sorting">Email</th>
                        <th id="table-inviter" class="sorting">Inviter</th>
                        <th id="table-inviteCode" class="sorting">Invitation Code</th>
                        <th id="table-age" class="sorting">Age</th>
                        <th id="table-status" class="sorting">Status</th>
                        <th id="table-privilege" class="sorting">Privilege</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

    </div>

    <div class="footer">
        <div style="float:left;margin:1em">
            <img class="icon" src="/img/icon.png" style="width:3em;height:3em">
        </div>
        <div style="float:left;margin:1em">
            <p>Version: <span id="version">v5</span></p>
            <p>Copyright &copy; 2022 My Memo</p>
        </div>
        <div style="float:right;margin:1em">
            <p>Open sourced at <a href="https://github.com/Charles-1414/MyMemo" target="_blank"
                    rel="noopener noreferrer"><i class="fa fa-brands fa-github"></i>
                    GitHub</a></p>
            <p>Developed by <a href="https://www.charles14.xyz" target="_blank" rel="noopener noreferrer">Charles</a>
            </p>
        </div>
    </div>
</body>

</html>