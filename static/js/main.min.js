// Copyright (C) 2021 Charles All rights reserved.
// Author: @Charles-1414
// License: GNU General Public License v3.0

function btninit(){for(var t=0;t<btncnt;t++)buttons[t].x=canvas.width+5e3,buttons[t].y=canvas.height+5e3}function btnresize(){for(var t=0;t<btncnt;t++)buttons[t].w=Math.min(buttons[t].orgw,parseInt(buttons[t].orgw*window.innerWidth/windowOrgW*window.innerHeight/windowOrgH)),buttons[t].h=Math.min(buttons[t].orgh,parseInt(buttons[t].orgh*window.innerHeight/windowOrgH*window.innerWidth/windowOrgW*1.2));wordBookW=Math.min(wordBookOrgW,parseInt(wordBookOrgW*window.innerWidth/windowOrgW*window.innerHeight/windowOrgH)),wordBookH=Math.min(wordBookOrgH,parseInt(wordBookOrgH*window.innerWidth/windowOrgW*window.innerHeight/windowOrgH))}function fontresize(){fontSize=Math.min(orgFontSize,parseInt(orgFontSize*window.innerWidth/windowOrgW)),largeFontSize=Math.min(orglargeFontSize,parseInt(orglargeFontSize*window.innerWidth/windowOrgW)),smallFontSize=Math.min(orgsmallFontSize,parseInt(orgsmallFontSize*window.innerWidth/windowOrgW)),isphone&&(fontSize*=1.5,largeFontSize*=1.5,smallFontSize*=1.5)}function updateWordListTable(){if(0!=wordBookList.length){table=$("#wordList").DataTable(),table.clear(),wordBookIdx=0;for(var t=0;t<wordBookList.length;t++)if(wordBookList[t].wordBookId==wordBookId){wordBookIdx=t;break}for(t=0;t<wordBookList[wordBookIdx].words.length;t++)wordId=wordBookList[wordBookIdx].words[t],wordData=wordListMap.get(wordId),null!=wordData&&(table.row.add([[wordData.word],[wordData.translation],[l[wordData.status]]]).node().id=wordId);table.draw()}}function updateGroupMember(t=!1){groupId==lstUpdateGroupId&&Date.now()-lstGMupdate<6e4&&!t||(table=$("#groupMember").DataTable(),table.clear(),table.row.add([["Loading..."],[""]]),table.draw(),table.clear(),$.ajax({url:"/api/group/member",method:"POST",async:!0,dataType:"json",data:{userId:localStorage.getItem("userId"),token:localStorage.getItem("token"),groupId:groupId},success:function(t){wordBookName=t.name,$("#groupDescriptionP").show(),$("#groupDescription").html(t.description);for(var o=0;o<t.member.length;o++)table.row.add([[t.member[o].username],[t.member[o].progress]]).node().id=t.member[o].userId;table.draw()},error:function(t){table.row.add([["Failed to fetch group member list"],[""]]),table.draw()}}))}function updateWordList(t=!0,o=!1){Date.now()-lastWordListUpdate<1e4&&!o?updateWordListTable():(lastWordListUpdate=Date.now(),$.ajax({url:"/api/wordBook/wordList",method:"POST",async:t,dataType:"json",data:{userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){wordList=t,wordListMap=new Map;for(var o=0;o<wordList.length;o++)wordListMap.set(wordList[o].wordId,{word:wordList[o].word,translation:wordList[o].translation,status:wordList[o].status});l=["","Default","Tagged","Deleted"],localStorage.setItem("wordList",JSON.stringify(wordList)),words=[];for(o=0;o<wordList.length;o++)words.push(wordList[o].wordId);updateWordListTable()},error:function(t){updateWordListTable()}}))}function updateWordBookList(t=!0,o=!1){Date.now()-lastWordBookListUpdate<3e4&&!o||(lastWordBookListUpdate=Date.now(),updateWordList(!1,!0),$.ajax({url:"/api/wordBook",method:"POST",async:t,dataType:"json",data:{userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){words=[];for(var o=0;o<wordList.length;o++)words.push(wordList[o].wordId);wordBookList=[];for(o=0;o<t.length;o++)wordBookList.push(t[o]);wordBookCnt=wordBookList.length,localStorage.setItem("wordBookList",JSON.stringify(wordBookList));for(o=0;o<wordBookList.length;o++){if(wordBookList[o].wordBookId==wordBookId&&(wordBookName=wordBookList[o].name,wordBookShareCode=wordBookList[o].shareCode,groupCode=wordBookList[o].groupCode,groupId=wordBookList[o].groupId,isGroupOwner=wordBookList[o].isGroupOwner,""!=wordBookShareCode?($("#wordBookShareCode").html(wordBookShareCode),$("#shareop").html("Unshare")):($("#wordBookShareCode").html("(Private)"),$("#shareop").html("Share")),""!=groupCode?($("#groupCode").html(groupCode),$("#groupop").html("Dismiss"),$("#groupdetail").show(),$("#quitgroup").show(),0==isGroupOwner?$("#groupop").hide():$("#groupop").show()):($("#groupCode").html("(Word book not bound to a group)"),$("#groupop").html("Create group"),$("#groupdetail").hide(),$("#quitgroup").hide(),$("#groupmng").hide()),0==wordBookId?($("#wbupdate").hide(),$("#wbremoveword").hide(),$("#group").hide()):($("#wbupdate").show(),$("#wbremoveword").show(),$("#group").show()),0==isGroupOwner?$("#groupmng").hide():$("#groupmng").show()),wordBookList[o].wordBookId==selectedWordBook){selectedWordBookName=wordBookList[o].name,selectedWordList=[];for(var e=0;e<wordBookList[o].words.length;e++)wordId=wordBookList[o].words[e],wordData=wordListMap.get(wordId),selectedWordList.push({wordId:wordId,word:wordData.word,translation:wordData.translation,status:wordData.status})}""==selectedWordBookName&&(selectedWordBook=0,localStorage.setItem("selectedWordBook",selectedWordBook))}}}))}function updateWordBookWordList(t=!1){table=$("#wordList").DataTable(),table.clear(),table.row.add([[""],["Loading..."],[""]]),table.draw(),updateWordBookList(!1,t),Date.now()-lastWordListUpdate<1e4&&!t?updateWordListTable():updateWordList(!0,t)}function selectAll(){$("#wordList tr").each(function(){wid=parseInt($(this).attr("id")),wid!=wid||$(this).hasClass("selected")||selected.push(wid),$(this).addClass("selected")})}function deselectAll(){$("#wordList tr").each(function(){wid=parseInt($(this).attr("id")),wid==wid&&$(this).hasClass("selected")&&(idx=selected.indexOf(wid),idx>-1&&selected.splice(idx,1)),$(this).removeClass("selected")})}function displayRandomWord(){0!=selectedWordList.length&&(index=parseInt(Math.random()*selectedWordList.length),wordId=selectedWordList[index].wordId,word=selectedWordList[index].word,translation=selectedWordList[index].translation,wordStatus=selectedWordList[index].status,$("#startfrom").val(word))}function renderHomePage(){btninit(),$("#wordList_wrapper").hide(),ctx.clearRect(0,0,canvas.width,canvas.height),canvas.width=window.innerWidth-25,canvas.height=window.innerHeight-25,ctx.textAlign="center",ctx.font=largeFontSize+"px Impact",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Word Memo",canvas.width/2,canvas.height/2-100),buttons[0].x=canvas.width/2-buttons[0].w/2,buttons[0].y=canvas.height/2+buttons[0].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[0].x,buttons[0].y,buttons[0].w,buttons[0].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Start",buttons[0].x+buttons[0].w/2,buttons[0].y+buttons[0].h/1.4),0==displayMode?ctx.fillText("Practice Mode",buttons[0].x+buttons[0].w/2,buttons[0].y+2.2*buttons[0].h):1==displayMode?ctx.fillText("Challenge Mode",buttons[0].x+buttons[0].w/2,buttons[0].y+2.2*buttons[0].h):2==displayMode&&ctx.fillText("Offline Mode",buttons[0].x+buttons[0].w/2,buttons[0].y+2.2*buttons[0].h),ctx.fillText(selectedWordBookName,buttons[0].x+buttons[0].w/2,buttons[0].y+3.4*buttons[0].h),buttons[20].x=canvas.width-1.2*buttons[20].w,buttons[20].y=.2*buttons[20].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[20].x,buttons[20].y,buttons[20].w,buttons[20].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Account",buttons[20].x+buttons[20].w/2,buttons[20].y+buttons[20].h/1.4),buttons[14].x=canvas.width-1.2*buttons[14].w,buttons[14].y=1.5*buttons[14].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[14].x,buttons[14].y,buttons[14].w,buttons[14].h),ctx.font=.9*fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Settings",buttons[14].x+buttons[14].w/2,buttons[14].y+buttons[14].h/1.4),buttons[22].x=.2*buttons[22].w,buttons[22].y=.2*buttons[22].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[22].x,buttons[22].y,buttons[22].w,buttons[22].h),ctx.font=.6*fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Word Books",buttons[22].x+buttons[22].w/2,buttons[22].y+buttons[22].h/1.4),$("#startfrom").attr("style","position:absolute;left:"+(buttons[0].x+15)+";top:"+(buttons[0].y-buttons[0].h-20)+";height:"+buttons[0].h+";width:"+(buttons[0].w-14)+";font-size:"+.6*fontSize+";font-family:Corbel"),1==displayMode?$("#startfrom").attr("disabled","disabled"):$("#startfrom").removeAttr("disabled"),-1==randomDisplayer&&(randomDisplayer=setInterval(displayRandomWord,5e3))}function renderSettings(){-1!=randomDisplayer&&(clearInterval(randomDisplayer),randomDisplayer=-1),$("#addword_word").val(""),$("#addword_word").hide(),$("#addword_translation").val(""),$("#addword_translation").hide(),btninit(),ctx.clearRect(0,0,canvas.width,canvas.height),canvas.width=window.innerWidth-25,canvas.height=window.innerHeight-25,ctx.textAlign="center",buttons[15].x=canvas.width/2+buttons[15].w/2.5,buttons[15].y=2*buttons[15].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[15].x,buttons[15].y,buttons[15].w,buttons[15].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Mode:",buttons[15].x-.7*buttons[15].w,buttons[15].y+buttons[15].h/1.4),l=["Practice","Challenge","Offline"],ctx.fillText(l[displayMode],buttons[15].x+buttons[15].w/2,buttons[15].y+buttons[15].h/1.4),0==displayMode||2==displayMode?(buttons[4].x=canvas.width/2+buttons[4].w/1.2,buttons[4].y=3.5*buttons[4].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[4].x,buttons[4].y,buttons[4].w,buttons[4].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Display order: ",buttons[4].x-1.2*buttons[4].w,buttons[4].y+buttons[4].h/1.4),l=["Sequence","Random"],ctx.fillText(l[random],buttons[4].x+buttons[4].w/2,buttons[4].y+buttons[4].h/1.4),buttons[5].x=canvas.width/2+buttons[5].w/1.2,buttons[5].y=5*buttons[5].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[5].x,buttons[5].y,buttons[5].w,buttons[5].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Swap word & translation? ",buttons[5].x-1.4*buttons[5].w,buttons[5].y+buttons[5].h/1.4),l=["No","Yes"],ctx.fillText(l[swap],buttons[5].x+buttons[5].w/2,buttons[5].y+buttons[5].h/1.4),buttons[7].x=canvas.width/2+buttons[7].w/1.2,buttons[7].y=6.5*buttons[7].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[7].x,buttons[7].y,buttons[7].w,buttons[7].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("What to show? ",buttons[7].x-1.2*buttons[7].w,buttons[7].y+buttons[7].h/1.4),l=["","All","Tagged","Deleted"],ctx.fillText(l[showStatus],buttons[7].x+buttons[7].w/2,buttons[7].y+buttons[7].h/1.4),buttons[10].x=canvas.width/2+buttons[10].w/1.2,buttons[10].y=8*buttons[10].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[10].x,buttons[10].y,buttons[10].w,buttons[10].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Auto play:",buttons[10].x-1.2*buttons[10].w,buttons[10].y+buttons[10].h/1.4),l=["Disabled","Slow","Medium","Fast"],ctx.fillText(l[autoPlay],buttons[10].x+buttons[10].w/2,buttons[10].y+buttons[10].h/1.4)):1==displayMode&&(x=canvas.width/2+buttons[4].w/1.2,y=3.5*buttons[4].h,ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Display order: ",x-1.2*buttons[4].w,y+buttons[4].h/1.4),ctx.fillText("Random",x+buttons[4].w/2,y+buttons[4].h/1.4),buttons[5].x=canvas.width/2+buttons[5].w/1.2,buttons[5].y=5*buttons[5].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[5].x,buttons[5].y,buttons[5].w,buttons[5].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Swap word & translation? ",buttons[5].x-1.4*buttons[5].w,buttons[5].y+buttons[5].h/1.4),l=["No","Yes"],ctx.fillText(l[swap],buttons[5].x+buttons[5].w/2,buttons[5].y+buttons[5].h/1.4),x=canvas.width/2+buttons[7].w/1.2,y=6.5*buttons[7].h,ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("What to show? ",x-1.2*buttons[7].w,y+buttons[7].h/1.4),ctx.fillText("Everything",x+buttons[7].w/2,y+buttons[7].h/1.4),x=canvas.width/2+buttons[10].w/1.2,y=8*buttons[10].h,ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Auto play:",x-1.2*buttons[10].w,y+buttons[10].h/1.4),ctx.fillText("Disabled",x+buttons[10].w/2,y+buttons[10].h/1.4)),buttons[21].x=canvas.width/2-buttons[21].w/2,buttons[21].y=canvas.height-2.5*buttons[21].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[21].x,buttons[21].y,buttons[21].w,buttons[21].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Clear deleted words",buttons[21].x+buttons[21].w/2,buttons[21].y+buttons[21].h/1.4),buttons[9].x=canvas.width/2-buttons[9].w*(1+.6*btnMargin),buttons[9].y=canvas.height-1.2*buttons[9].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[9].x,buttons[9].y,buttons[9].w,buttons[9].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Import",buttons[9].x+buttons[9].w/2,buttons[9].y+buttons[9].h/1.4),buttons[12].x=canvas.width/2+buttons[12].w*btnMargin*.6,buttons[12].y=canvas.height-1.2*buttons[12].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[12].x,buttons[12].y,buttons[12].w,buttons[12].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Export",buttons[12].x+buttons[12].w/2,buttons[12].y+buttons[12].h/1.4),1!=lastpage?(buttons[8].gohome=1,buttons[8].x=.2*buttons[8].w,buttons[8].y=.2*buttons[8].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[8].x,buttons[8].y,buttons[8].w,buttons[8].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Home",buttons[8].x+buttons[8].w/2,buttons[8].y+buttons[8].h/1.4)):1==lastpage&&(buttons[0].x=.2*buttons[8].w,buttons[0].y=.2*buttons[8].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[0].x,buttons[0].y,buttons[8].w,buttons[8].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Resume",buttons[0].x+buttons[8].w/2,buttons[0].y+buttons[8].h/1.4)),ctx.font=fontSize+"px Impact",ctx.fillText("Settings",canvas.width/2,.2*buttons[8].h+buttons[8].h/1.4)}function renderAddWord(){ctx.clearRect(0,0,canvas.width,canvas.height),canvas.width=window.innerWidth-25,canvas.height=window.innerHeight-25,ctx.textAlign="center",ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Word: ",canvas.width/2-buttons[0].w/2,canvas.height/2-100),$("#addword_word").attr("style","position:absolute;left:"+canvas.width/2+";top:"+(canvas.height/2-118)+";font-size:"+.4*fontSize+";font-family:Corbel"),ctx.fillText("Translation: ",canvas.width/2-buttons[0].w/2,canvas.height/2-50),$("#addword_translation").attr("style","position:absolute;left:"+canvas.width/2+";top:"+(canvas.height/2-68)+";font-size:"+.4*fontSize+";font-family:Corbel"),editWord&&($("#addword_word").val(wordListMap.get(editWordId).word),$("#addword_translation").val(wordListMap.get(editWordId).translation)),$("#addword_word").focus(),buttons[8].gohome=0,buttons[8].x=.2*buttons[8].w,buttons[8].y=.2*buttons[8].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[8].x,buttons[8].y,buttons[8].w,buttons[8].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Back",buttons[8].x+buttons[8].w/2,buttons[8].y+buttons[8].h/1.4),buttons[19].x=canvas.width/2-buttons[19].w/2,buttons[19].y=canvas.height-3*buttons[19].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[19].x,buttons[19].y,buttons[19].w,buttons[19].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),editWord?ctx.fillText("Edit",buttons[19].x+buttons[19].w/2,buttons[19].y+buttons[19].h/1.4):ctx.fillText("Add",buttons[19].x+buttons[19].w/2,buttons[19].y+buttons[19].h/1.4),ctx.font=fontSize+"px Impact",ctx.fillStyle=getRndColor(10,100),editWord?ctx.fillText("Edit Word",canvas.width/2,.2*buttons[8].h+buttons[8].h/1.4):-1==addToWordBook?ctx.fillText("Add Word",canvas.width/2,.2*buttons[8].h+buttons[8].h/1.4):ctx.fillText("Add Word to "+wordBookName,canvas.width/2,.2*buttons[8].h+buttons[8].h/1.4)}function renderWord(t=0,o=0){if(-1!=randomDisplayer&&(clearInterval(randomDisplayer),randomDisplayer=-1),btninit(),showWord=!1,(0==swap||1==swap&&1==t||1==swap&&1==challengeStatus||1==swap&&3==challengeStatus||1==displayMode&&-1==wordId)&&(showWord=!0),showTranslation=!1,(1==swap||0==swap&&1==t||0==swap&&1==challengeStatus||0==swap&&3==challengeStatus||1==displayMode&&-1==wordId)&&(showTranslation=!0),$("#hiddenSpan").attr("style","display:none;font:"+fontSize+"px Corbel"),$("#hiddenSpan").html("test"),lineHeight=$("#hiddenSpan").height()+5,maxw=.8*window.innerWidth,curh=window.innerHeight/2-250,displayId!=wordId&&(displayWord=lineBreak(word,maxw,-1,fontSize+"px Corbel"),displayTranslation=lineBreak(translation,maxw,-1,fontSize+"px Corbel"),displayId=wordId),requireH=curh+6*buttons[0].h,showWord&&(requireH+=displayWord.split("\n").length*lineHeight),showTranslation&&(requireH+=displayTranslation.split("\n").length*lineHeight),ctx.clearRect(0,0,canvas.width,canvas.height),canvas.width=window.innerWidth-25,canvas.height=Math.max(window.innerHeight-25,requireH),localStorage.setItem("wordId",wordId),ctx.font=fontSize+"px Corbel",ctx.textAlign="center",ctx.fillStyle="black",showWord)for(var e=displayWord.split("\n"),r=0;r<e.length;r++)curh+=lineHeight,ctx.fillText(e[r],canvas.width/2,curh);if(curh+=10,ctx.fillStyle="gray",showTranslation)for(e=displayTranslation.split("\n"),r=0;r<e.length;r++)curh+=lineHeight,ctx.fillText(e[r],canvas.width/2,curh);ctx.fillStyle="black",$("#startfrom").val(word),rectcolor=getRndColor(160,250),textcolor=getRndColor(10,100),(0==swap||1==swap&&1==t||1==displayMode&&challengeStatus>0)&&-1!=wordId&&(buttons[3].x=canvas.width/2-buttons[3].w/2,buttons[3].y=canvas.height-bottomOffset,ctx.fillStyle=rectcolor,ctx.roundRect(buttons[3].x,buttons[3].y,buttons[3].w,buttons[3].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=textcolor,ctx.fillText("🔈",buttons[3].x+buttons[3].w/2,buttons[3].y+buttons[3].h/1.4)),0==displayMode?(ctx.fillText("Practice Mode",canvas.width/2,.2*buttons[0].h+buttons[0].h/1.4),buttons[1].x=canvas.width/2-buttons[1].w*(1+btnMargin),buttons[1].y=canvas.height-bottomOffset,ctx.fillStyle=rectcolor,ctx.roundRect(buttons[1].x,buttons[1].y,buttons[1].w,buttons[1].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=textcolor,ctx.fillText("Previous",buttons[1].x+buttons[1].w/2,buttons[1].y+buttons[1].h/1.4),buttons[2].x=canvas.width/2+buttons[2].w*btnMargin,buttons[2].y=canvas.height-bottomOffset,ctx.fillStyle=rectcolor,ctx.roundRect(buttons[2].x,buttons[2].y,buttons[2].w,buttons[2].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=textcolor,ctx.fillText("Next",buttons[2].x+buttons[2].w/2,buttons[2].y+buttons[2].h/1.4),buttons[6].x=canvas.width/2-buttons[6].w*(1+btnMargin),buttons[6].y=canvas.height-bottomOffset-1.5*buttons[6].h,ctx.fillStyle=rectcolor,ctx.roundRect(buttons[6].x,buttons[6].y,buttons[6].w,buttons[6].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=textcolor,2==wordStatus?ctx.fillText("Untag",buttons[6].x+buttons[6].w/2,buttons[6].y+buttons[6].h/1.4):ctx.fillText("Tag",buttons[6].x+buttons[6].w/2,buttons[6].y+buttons[6].h/1.4),buttons[11].x=canvas.width/2+buttons[11].w*btnMargin,buttons[11].y=canvas.height-bottomOffset-1.5*buttons[11].h,ctx.fillStyle=rectcolor,ctx.roundRect(buttons[11].x,buttons[11].y,buttons[11].w,buttons[11].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=textcolor,3==wordStatus?(ctx.font=.9*fontSize+"px Corbel",ctx.fillText("Undelete",buttons[11].x+buttons[11].w/2,buttons[11].y+buttons[11].h/1.4)):ctx.fillText("Delete",buttons[11].x+buttons[11].w/2,buttons[11].y+buttons[11].h/1.4)):1==displayMode?(ctx.fillText("Challenge Mode",canvas.width/2,.2*buttons[0].h+buttons[0].h/1.4),-1!=wordId&&(3!=challengeStatus&&(buttons[16].x=canvas.width/2-buttons[16].w*(1+btnMargin),buttons[16].y=canvas.height-bottomOffset-1.5*buttons[16].h,ctx.fillStyle=rectcolor,ctx.roundRect(buttons[16].x,buttons[16].y,buttons[16].w,buttons[16].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=textcolor,ctx.fillText("Yes",buttons[16].x+buttons[16].w/2,buttons[16].y+buttons[16].h/1.4)),ctx.textAlign="center",0==challengeStatus?ctx.fillText("Do you remember it?",canvas.width/2,buttons[16].y-buttons[16].h/1.4):1==challengeStatus?ctx.fillText("Are you correct?",canvas.width/2,buttons[16].y-buttons[16].h/1.4):3==challengeStatus&&(x=canvas.width/2-buttons[16].w*(1+btnMargin),y=canvas.height-bottomOffset-1.5*buttons[16].h,ctx.fillText("Try to memorize it!",canvas.width/2,y-buttons[16].h/1.4)),buttons[17].x=canvas.width/2+buttons[17].w*btnMargin,buttons[17].y=canvas.height-bottomOffset-1.5*buttons[17].h,ctx.fillStyle=rectcolor,ctx.roundRect(buttons[17].x,buttons[17].y,buttons[17].w,buttons[17].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=textcolor,3!=challengeStatus?ctx.fillText("No",buttons[17].x+buttons[17].w/2,buttons[17].y+buttons[17].h/1.4):ctx.fillText("Next",buttons[17].x+buttons[17].w/2,buttons[17].y+buttons[17].h/1.4),buttons[6].x=canvas.width/2-buttons[6].w*(1+btnMargin),buttons[6].y=canvas.height-bottomOffset,ctx.fillStyle=rectcolor,ctx.roundRect(buttons[6].x,buttons[6].y,buttons[6].w,buttons[6].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=textcolor,2==wordStatus?ctx.fillText("Untag",buttons[6].x+buttons[6].w/2,buttons[6].y+buttons[6].h/1.4):ctx.fillText("Tag",buttons[6].x+buttons[6].w/2,buttons[6].y+buttons[6].h/1.4),buttons[11].x=canvas.width/2+buttons[11].w*btnMargin,buttons[11].y=canvas.height-bottomOffset,ctx.fillStyle=rectcolor,ctx.roundRect(buttons[11].x,buttons[11].y,buttons[11].w,buttons[11].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=textcolor,3==wordStatus?(ctx.font=.9*fontSize+"px Corbel",ctx.fillText("Undelete",buttons[11].x+buttons[11].w/2,buttons[11].y+buttons[11].h/1.4)):ctx.fillText("Delete",buttons[11].x+buttons[11].w/2,buttons[11].y+buttons[11].h/1.4))):2==displayMode&&(ctx.fillText("Offline Mode",canvas.width/2,.2*buttons[0].h+buttons[0].h/1.4),buttons[1].x=canvas.width/2-buttons[1].w*(1+btnMargin),buttons[1].y=canvas.height-bottomOffset,ctx.fillStyle=rectcolor,ctx.roundRect(buttons[1].x,buttons[1].y,buttons[1].w,buttons[1].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=textcolor,ctx.fillText("Previous",buttons[1].x+buttons[1].w/2,buttons[1].y+buttons[1].h/1.4),buttons[2].x=canvas.width/2+buttons[2].w*btnMargin,buttons[2].y=canvas.height-bottomOffset,ctx.fillStyle=rectcolor,ctx.roundRect(buttons[2].x,buttons[2].y,buttons[2].w,buttons[2].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=textcolor,ctx.fillText("Next",buttons[2].x+buttons[2].w/2,buttons[2].y+buttons[2].h/1.4)),0!=autoPlay&&(0==displayMode?(buttons[13].x=canvas.width/2-buttons[13].w*(1+btnMargin),buttons[13].y=canvas.height-bottomOffset-3*buttons[13].h,ctx.fillStyle=rectcolor,ctx.roundRect(buttons[13].x,buttons[13].y,buttons[13].w,buttons[13].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=textcolor,appaused?ctx.fillText("Play",buttons[13].x+buttons[13].w/2,buttons[13].y+buttons[13].h/1.4):ctx.fillText("Pause",buttons[13].x+buttons[13].w/2,buttons[13].y+buttons[13].h/1.4)):2==displayMode&&(buttons[13].x=canvas.width/2-buttons[13].w*(1+btnMargin),buttons[13].y=canvas.height-bottomOffset-1.5*buttons[13].h,ctx.fillStyle=rectcolor,ctx.roundRect(buttons[13].x,buttons[13].y,buttons[13].w,buttons[13].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=textcolor,appaused?ctx.fillText("Play",buttons[13].x+buttons[13].w/2,buttons[13].y+buttons[13].h/1.4):ctx.fillText("Pause",buttons[13].x+buttons[13].w/2,buttons[13].y+buttons[13].h/1.4))),0==autoPlay||appaused||o||0==swap&&(speaker.cancel(),msg=new SpeechSynthesisUtterance(word),speaker.speak(msg)),2!=displayMode&&(buttons[18].x=canvas.width-1.2*buttons[18].w,buttons[18].y=1.5*buttons[18].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[18].x,buttons[18].y,buttons[18].w,buttons[18].h),ctx.font=.9*fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Statistics",buttons[18].x+buttons[18].w/2,buttons[18].y+buttons[18].h/1.4)),buttons[8].gohome=1,buttons[8].x=.2*buttons[8].w,buttons[8].y=.2*buttons[8].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[8].x,buttons[8].y,buttons[8].w,buttons[8].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Home",buttons[8].x+buttons[8].w/2,buttons[8].y+buttons[8].h/1.4),buttons[14].x=canvas.width-1.2*buttons[14].w,buttons[14].y=.2*buttons[14].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[14].x,buttons[14].y,buttons[14].w,buttons[14].h),ctx.font=.9*fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Settings",buttons[14].x+buttons[14].w/2,buttons[14].y+buttons[14].h/1.4),lastpage=1}function renderWordBookList(){btninit(),ctx.clearRect(0,0,canvas.width,canvas.height),canvas.width=window.innerWidth-25,canvas.height=Math.max(window.innerHeight-25,4*buttons[0].h+wordBookH*Math.ceil(wordBookCnt/4)*1.1),ctx.textAlign="center",buttons[8].gohome=1,buttons[8].x=.2*buttons[8].w,buttons[8].y=.2*buttons[8].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[8].x,buttons[8].y,buttons[8].w,buttons[8].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Home",buttons[8].x+buttons[8].w/2,buttons[8].y+buttons[8].h/1.4),ctx.font=fontSize+"px Impact",ctx.fillText("Word Book",canvas.width/2,.2*buttons[8].h+buttons[8].h/1.4),ctx.font=fontSize+"px Corbel",wordBookRect=[],ctx.textAlign="left";for(var o=0;o<wordBookCnt;o++){x=canvas.width+1,y=canvas.height+1,isphone?(o%2==0?x=canvas.width/2-1.05*wordBookW:o%2==1&&(x=canvas.width/2+.05*wordBookW),y=buttons[8].y+1.2*buttons[8].h+parseInt(o/2)*wordBookH*1.1):(o%4==0?x=canvas.width/2-2.15*wordBookW:o%4==1?x=canvas.width/2-1.05*wordBookW:o%4==2?x=canvas.width/2+.05*wordBookW:o%4==3&&(x=canvas.width/2+1.15*wordBookW),y=buttons[8].y+1.2*buttons[8].h+parseInt(o/4)*wordBookH*1.1),wordBookRect.push({wordBookId:wordBookList[o].wordBookId,x:x,y:y}),ctx.fillStyle=getRndColor(160,250),ctx.roundRect(x,y,wordBookW,wordBookH),displayName=lineBreak(wordBookList[o].name,6*wordBookW/8,maxLine=2,font=.75*fontSize+"px Corbel"),ctx.fillStyle=getRndColor(10,150),ctx.font=.75*fontSize+"px Corbel";for(var e=displayName.split("\n"),r=0;r<e.length;r++)ctx.fillText(e[r],x+wordBookW/8,y+wordBookH/(3.6-2*r));t=2,2==e.length&&(t=1.2),ctx.font=smallFontSize+"px Corbel",0!=wordBookList[o].wordBookId?ctx.fillText(wordBookList[o].progress+" memorized / "+wordBookList[o].words.length+" words",x+wordBookW/8,y+wordBookH/t):ctx.fillText(wordBookList[o].words.length+" words",x+wordBookW/8,y+wordBookH/t)}ctx.textAlign="center",ctx.font=fontSize+"px Corbel",$("#wordBookName").attr("style","position:absolute;    left:"+(canvas.width/2-buttons[23].w-10)+";top:"+(canvas.height-1.75*buttons[23].h)+";    height:"+buttons[23].h+";width:"+buttons[23].w+";    font-size:"+.6*fontSize+";font-family:Corbel"),$("#wordBookName").show(),buttons[23].x=canvas.width/2+10,buttons[23].y=canvas.height-2*buttons[23].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[23].x,buttons[23].y,buttons[23].w,buttons[23].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Create Word Book",buttons[23].x+buttons[23].w/2,buttons[23].y+buttons[23].h/1.4)}function renderWordBookDetail(){btninit(),ctx.clearRect(0,0,canvas.width,canvas.height),canvas.width=window.innerWidth-25,canvas.height=window.innerHeight-25,ctx.textAlign="center",buttons[8].gohome=0,buttons[8].x=.2*buttons[8].w,buttons[8].y=.2*buttons[8].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[8].x,buttons[8].y,buttons[8].w,buttons[8].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Back",buttons[8].x+buttons[8].w/2,buttons[8].y+buttons[8].h/1.4),color=getRndColor(160,250),selectedWordBook==wordBookId&&(color="#cccccc"),buttons[25].x=canvas.width-1.2*buttons[25].w,buttons[25].y=.2*buttons[25].h,ctx.fillStyle=color,ctx.roundRect(buttons[25].x,buttons[25].y,buttons[25].w,buttons[25].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),selectedWordBook==wordBookId?ctx.fillText("Selected",buttons[25].x+buttons[25].w/2,buttons[25].y+buttons[25].h/1.4):ctx.fillText("Select",buttons[25].x+buttons[25].w/2,buttons[25].y+buttons[25].h/1.4),ctx.font=fontSize+"px Impact",ctx.fillText(wordBookName,canvas.width/2,.2*buttons[8].h+buttons[8].h/1.4),ctx.font=fontSize+"px Corbel",$("#wbplaceholder").attr("style","height:"+1.75*buttons[0].h),$("#mngWBbtn").show(),$("#mngWBbtn").attr("style","text-align:left;z-index:999;    margin-left:"+.5*buttons[0].w+";padding-bottom: 20px;    height: "+buttons[0].h+";width:"+(window.innerWidth-25-buttons[0].w)+";    background-color:"+getRndColor(160,250)+";    font-size:"+.8*smallFontSize+";font-family:Corbel;"),$("#mngWBclp").attr("style","display:"+colldisplay+";text-align:left;z-index:999;    margin-left:"+.5*buttons[0].w+";padding-bottom: 50px;    width:"+(window.innerWidth-25-buttons[0].w)+";    font-size:"+.8*smallFontSize+";font-family:Corbel;"),""!=wordBookShareCode?($("#wordBookShareCode").html(wordBookShareCode),$("#shareop").html("Unshare")):($("#wordBookShareCode").html("(Private)"),$("#shareop").html("Share")),""!=groupCode?($("#groupCode").html(groupCode),$("#groupop").html("Dismiss"),$("#groupdetail").show(),$("#quitgroup").show(),0==isGroupOwner?$("#groupop").hide():$("#groupop").show()):($("#groupCode").html("(Word book not bound to a group)"),$("#groupop").html("Create group"),$("#groupdetail").hide(),$("#quitgroup").hide(),$("#groupmng").hide()),0==wordBookId?($("#wbupdate").hide(),$("#wbremoveword").hide(),$("#group").hide()):($("#wbupdate").show(),$("#wbremoveword").show(),$("#group").show()),0==isGroupOwner?$("#groupmng").hide():$("#groupmng").show(),$("#wordList_wrapper").show(),$("#wordList_wrapper").attr("style","text-align:center;z-index:999;    margin-left:"+.5*buttons[0].w+";padding-bottom:50px;    width:"+(window.innerWidth-25-buttons[0].w)+";    font-size:"+.8*smallFontSize+";font-family:Corbel;"),$("#wordList").attr("style","width:100%;font-size:"+.8*smallFontSize+";font-family:Corbel"),updateWordListTable(),ctx.font=fontSize+"px Corbel"}function renderWordBookAddWord(){btninit(),ctx.clearRect(0,0,canvas.width,canvas.height),canvas.width=window.innerWidth-25,canvas.height=window.innerHeight-25,ctx.textAlign="center",buttons[8].gohome=0,buttons[8].x=.2*buttons[8].w,buttons[8].y=.2*buttons[8].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[8].x,buttons[8].y,buttons[8].w,buttons[8].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Back",buttons[8].x+buttons[8].w/2,buttons[8].y+buttons[8].h/1.4),buttons[24].x=canvas.width-1.2*buttons[24].w,buttons[24].y=.2*buttons[24].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[24].x,buttons[24].y,buttons[24].w,buttons[24].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Add",buttons[24].x+buttons[24].w/2,buttons[24].y+buttons[24].h/1.4),ctx.font=fontSize+"px Impact",ctx.fillText("Add Word to "+wordBookName,canvas.width/2,.2*buttons[8].h+buttons[8].h/1.4),ctx.font=fontSize+"px Corbel",ctx.textAlign="left",ctx.font=smallFontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),$("#wbplaceholder").attr("style","height:"+1.75*buttons[0].h),$("#wordList_wrapper").show(),$("#wordList_wrapper").attr("style","text-align:center;z-index:999;    margin-left:"+.5*buttons[0].w+";padding-bottom:10px;    width:"+(window.innerWidth-25-buttons[0].w)+";    font-size:"+.8*smallFontSize+";font-family:Corbel;"),$("#wordList").attr("style","width:100%;font-size:"+.8*smallFontSize+";font-family:Corbel"),$("#wordBookNewWord").show(),$("#wordBookNewWord").attr("style","margin-left:"+.5*buttons[0].w+";padding-bottom:50px;z-index:999;    font-size:"+.8*smallFontSize+";font-family:Corbel"),table=$("#wordList").DataTable(),table.clear(),table.row.add([[""],["Loading..."],[""]]),table.draw(),table.clear(),curid=wordBookId,wordBookId=0,updateWordList(!1,!0),wordBookId=curid}function renderGroupMember(){btninit(),ctx.clearRect(0,0,canvas.width,canvas.height),canvas.width=window.innerWidth-25,canvas.height=window.innerHeight-25,ctx.textAlign="center",
buttons[8].gohome=0,buttons[8].x=.2*buttons[8].w,buttons[8].y=.2*buttons[8].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[8].x,buttons[8].y,buttons[8].w,buttons[8].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Back",buttons[8].x+buttons[8].w/2,buttons[8].y+buttons[8].h/1.4),ctx.font=fontSize+"px Impact",ctx.fillText(wordBookName,canvas.width/2,.2*buttons[8].h+buttons[8].h/1.4),ctx.font=fontSize+"px Corbel",$("#wbplaceholder").attr("style","height:"+1.75*buttons[0].h),$("#groupDescriptionP").attr("style","text-align:left;z-index:999;    margin-left:"+.5*buttons[0].w+";padding-bottom: 10px;    height: "+buttons[0].h+";width:"+(window.innerWidth-25-buttons[0].w)+";    font-size:"+.8*smallFontSize+";font-family:Corbel;"),isGroupOwner&&($("#mngGMbtn").show(),$("#mngGMbtn").attr("style","text-align:left;z-index:999;        margin-left:"+.5*buttons[0].w+";padding-bottom: 20px;        height: "+buttons[0].h+";width:"+(window.innerWidth-25-buttons[0].w)+";        background-color:"+getRndColor(160,250)+";        font-size:"+.8*smallFontSize+";font-family:Corbel;"),$("#mngGMclp").attr("style","display:"+colldisplay+";text-align:left;z-index:999;        margin-left:"+.5*buttons[0].w+";padding-bottom: 50px;        width:"+(window.innerWidth-25-buttons[0].w)+";        font-size:"+.8*smallFontSize+";font-family:Corbel;")),$("#groupMember_wrapper").show(),$("#groupMember_wrapper").attr("style","text-align:center;z-index:999;    margin-left:"+.5*buttons[0].w+";padding-bottom:50px;    width:"+(window.innerWidth-25-buttons[0].w)+";    font-size:"+.8*smallFontSize+";font-family:Corbel;"),$("#groupMember").attr("style","width:100%;font-size:"+.8*smallFontSize+";font-family:Corbel"),updateGroupMember(),ctx.font=fontSize+"px Corbel"}function renderCurrentPage(t=-1){-1!=t&&(lastpage=currentpage,currentpage=t),1!=currentpage&&(appaused=0,clearInterval(apinterval),apinterval=-1,speaker.cancel()),selected=[],btninit(),localStorage.setItem("currentpage",currentpage),localStorage.setItem("lastpage",lastpage),wordBookRect=[],loaded=!1,sleep(50).then(()=>{$("#wordBookName").hide(),$("#wordList_wrapper").hide(),$("#groupMember_wrapper").hide(),$("#startfrom").hide(),$("#addword_word").hide(),$("#addword_translation").hide(),$("#mngWBbtn").hide(),$("#mngWBclp").hide(),$("#mngGMbtn").hide(),$("#mngGMclp").hide(),$("#wordBookNewWord").hide(),$("#groupDescriptionP").hide(),0==currentpage?renderHomePage():1==currentpage?renderWord():2==currentpage?renderSettings():3==currentpage?renderAddWord():4==currentpage?renderWordBookDetail():5==currentpage?renderWordBookList():6==currentpage?renderWordBookAddWord():7==currentpage&&renderGroupMember(),loaded=!0})}function renderCurrentPageResize(){$("#wordList").DataTable().destroy(),$("#wordList").DataTable({pagingType:"full_numbers"}),$("#wordList_length").append('&nbsp;&nbsp;|&nbsp;&nbsp;<a onClick="selectAll();" href="#">Select All</a>'),$("#wordList_length").append('&nbsp;&nbsp;|&nbsp;&nbsp;<a onClick="deselectAll();" href="#">Deselect All</a>'),$("#wordList_length").append("&nbsp;&nbsp;|&nbsp;&nbsp;Double click word to edit"),$("#groupMember").DataTable().destroy(),$("#groupMember").DataTable({pagingType:"full_numbers"}),$("#groupMember_length").append("&nbsp;&nbsp;|&nbsp;&nbsp;A word is regarded as memorized once the user passed 2 challenges in a row"),btnresize(),fontresize(),renderCurrentPage()}function autoPlayer(){if(console.log("auto player running"),moveType=1-random,0==displayMode)$.ajax({url:"/api/word/next",method:"POST",async:!0,dataType:"json",data:{wordId:wordId,status:showStatus,moveType:moveType,wordBookId:selectedWordBook,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){word=t.word,translation=t.translation,wordStatus=t.status,wordId=t.wordId,displayingAnswer=0,renderCurrentPage()},error:function(t,o,e){401==t.status?(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user"):($("#startfrom").hide(),word=t.status+" "+e,translation="Maybe change the settings?\nOr check your connection?",renderWord(1,1))}});else if(2==displayMode){displayingAnswer=0,requiredList=[];for(var t=0;t<selectedWordList.length;t++)1!=showStatus||1!=selectedWordList[t].status&&2!=selectedWordList[t].status?2==showStatus&&2==selectedWordList[t].status?requiredList.push(selectedWordList[t]):3==showStatus&&3==selectedWordList[t].status&&requiredList.push(selectedWordList[t]):requiredList.push(selectedWordList[t]);if(0==moveType)index=parseInt(Math.random()*requiredList.length),wordId=requiredList[index].wordId,word=requiredList[index].word,translation=requiredList[index].translation,wordStatus=requiredList[index].status;else if(1==moveType||-1==moveType){index=-1;for(t=0;t<requiredList.length;t++)if(requiredList[t].wordId==wordId){index=t;break}if(-1==index)return $("#startfrom").hide(),word="",translation="Unknown error",void renderWord(1,1);-1==moveType&&index>0||1==moveType&&index<requiredList.length-1?index+=moveType:-1==moveType&&0==index?index=requiredList.length-1:1==moveType&&index==requiredList.length-1&&(index=0),wordId=requiredList[index].wordId,word=requiredList[index].word,translation=requiredList[index].translation,wordStatus=requiredList[index].status}renderCurrentPage()}}function startfunc(){if(0==displayMode)""!=$("#startfrom").val()?(startword=$("#startfrom").val(),$.ajax({url:"/api/word/id",method:"POST",async:!1,dataType:"json",data:{word:startword,wordBookId:wordBookId,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){wordId=t.wordId,btninit(),$.ajax({url:"/api/word",method:"POST",async:!1,dataType:"json",data:{wordId:wordId,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){word=t.word,translation=t.translation,wordStatus=t.status,wordId=t.wordId,renderCurrentPage(1),-1==apinterval&&0!=autoPlay&&(apinterval=setInterval(autoPlayer,1e3*apdelay[autoPlay]))},error:function(t,o,e){401==t.status?(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user"):($("#startfrom").hide(),word=t.status+" "+e,translation="Maybe change the settings?\nOr check your connection?",renderWord(1,1))}})},error:function(t,o,e){404==t.status?($("#startfrom").val("Not found!"),displayRandomWord(),renderCurrentPage(1)):401==t.status?(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user"):($("#startfrom").hide(),word=t.status+" "+e,translation="Maybe change the settings?\nOr check your connection?",renderWord(1,1))}})):$.ajax({url:"/api/word/next",method:"POST",async:!1,dataType:"json",data:{status:showStatus,moveType:0,wordBookId:selectedWordBook,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){wordId=t.wordId,btninit(),word=t.word,translation=t.translation,wordStatus=t.status,renderCurrentPage(1),appaused=0,-1==apinterval&&0!=autoPlay&&(apinterval=setInterval(autoPlayer,1e3*apdelay[autoPlay]))},error:function(t,o,e){401==t.status?(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user"):($("#startfrom").hide(),word=t.status+" "+e,translation="Maybe change the settings?\nOr check your connection?",renderWord(1,1))}});else if(1==displayMode)$.ajax({url:"/api/word/challenge/next",method:"POST",async:!1,dataType:"json",data:{wordBookId:selectedWordBook,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){word=t.word,$("#startfrom").val(word),translation=t.translation,wordStatus=t.status,wordId=t.wordId,btninit(),renderCurrentPage(1)},error:function(t){401==t.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}});else if(2==displayMode){if(selectedWordList==[])return void alert("Unable to start offline mode: No data in word list!");if(""!=$("#startfrom").val()){startword=$("#startfrom").val(),found=!1;for(var t=0;t<selectedWordList.length;t++)selectedWordList[t].word==startword&&(wordId=selectedWordList[t].wordId,word=selectedWordList[t].word,translation=selectedWordList[t].translation,wordStatus=selectedWordList[t].status,found=!0);found||(0==currentpage?$("#startfrom").val("Not found!"):(index=parseInt(Math.random()*selectedWordList.length),wordId=selectedWordList[index].wordId,word=selectedWordList[index].word,translation=selectedWordList[index].translation,wordStatus=selectedWordList[index].status))}else index=parseInt(Math.random()*selectedWordList.length),wordId=selectedWordList[index].wordId,word=selectedWordList[index].word,translation=selectedWordList[index].translation,wordStatus=selectedWordList[index].status;btninit(),appaused=0,renderCurrentPage(1),-1==apinterval&&0!=autoPlay&&(apinterval=setInterval(autoPlayer,1e3*apdelay[autoPlay]))}}function createWordBook(){wordBookName=$("#wordBookName").val(),""!=wordBookName?$.ajax({url:"/api/wordBook/create",method:"POST",async:!0,dataType:"json",data:{name:wordBookName,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){1==t.success?($("#wordBookName").val(""),updateWordBookList(!1,!0),renderCurrentPage()):alert(t.msg)},error:function(t){401==t.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}}):alert("Enter a word book name!")}function clickHandler(t){if(!(Date.now()-lastpress<50)){lastpress=Date.now();for(var o=t.pageX-canvas.offsetLeft,e=t.pageY-canvas.offsetTop,r=0,n=0;n<btncnt;n++)if(o>=buttons[n].x&&o<=buttons[n].x+buttons[n].w&&e>=buttons[n].y&&e<=buttons[n].y+buttons[n].h)if(r=1,console.log(buttons[n].name+" button triggered"),"start"==buttons[n].name)sleep(50).then(()=>{startfunc()});else if(1!=currentpage||"previous"!=buttons[n].name&&"next"!=buttons[n].name)if(1!=currentpage||"tag"!=buttons[n].name&&"remove"!=buttons[n].name)if(1!=currentpage||"sound"!=buttons[n].name||speaker.speaking){if("challengeyes"==buttons[n].name)0==challengeStatus?(challengeStatus=1,renderCurrentPage()):1==challengeStatus&&$.ajax({url:"/api/word/challenge/update",method:"POST",async:!0,dataType:"json",data:{wordId:wordId,memorized:1,getNext:1,wordBookId:selectedWordBook,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){challengeStatus=0,word=t.word,translation=t.translation,wordStatus=t.status,wordId=t.wordId,renderCurrentPage()},error:function(t){401==t.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}});else if("challengeno"==buttons[n].name)0==challengeStatus||1==challengeStatus?(challengeStatus=3,$.ajax({url:"/api/word/challenge/update",method:"POST",async:!0,dataType:"json",data:{wordId:wordId,memorized:0,getNext:0,wordBookId:selectedWordBook,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")}}),renderCurrentPage()):3==challengeStatus&&$.ajax({url:"/api/word/challenge/next",method:"POST",async:!0,dataType:"json",data:{wordBookId:selectedWordBook,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){challengeStatus=0,word=t.word,translation=t.translation,wordStatus=t.status,wordId=t.wordId,renderCurrentPage()},error:function(t){401==t.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}});else if("back"==buttons[n].name){if(1==buttons[n].gohome||1==currentpage||5==currentpage)return void renderCurrentPage(0);if(1==lastpage)return renderCurrentPage(1),appaused=0,void(-1==apinterval&&0!=autoPlay&&(apinterval=setInterval(autoPlayer,1e3*apdelay[autoPlay])));if(4==currentpage)return void renderCurrentPage(5);if(6==currentpage||3==currentpage)return void renderCurrentPage(4);if(currentpage==lastpage)return void renderCurrentPage(0);renderCurrentPage(lastpage)}else if("settings"==buttons[n].name)renderCurrentPage(2);else if("wordbook"==buttons[n].name)renderCurrentPage(5);else if("account"==buttons[n].name)window.location.href="/user";else if("addword"==buttons[n].name){if(ctx.font=fontSize+"px Corbel",ctx.textAlign="center",word=$("#addword_word").val(),translation=$("#addword_translation").val(),""==word||""==translation)return ctx.fillStyle="white",ctx.roundRect(0,buttons[19].y-2.5*buttons[19].h,canvas.width,1.5*buttons[19].h+5),ctx.fillStyle="red",void ctx.fillText("Both fields must be filled!",canvas.width/2,buttons[19].y-1.5*buttons[19].h);ctx.fillStyle="white",ctx.roundRect(0,buttons[19].y-2.5*buttons[19].h,canvas.width,1.5*buttons[19].h+5),ctx.fillStyle="blue",ctx.fillText("Submitting...",canvas.width/2,buttons[19].y-1.5*buttons[19].h),editWord?$.ajax({url:"/api/word/edit",method:"POST",async:!0,dataType:"json",data:{wordId:editWordId,word:word,translation:translation,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){ctx.fillStyle="white",ctx.roundRect(0,buttons[19].y-2.5*buttons[19].h,canvas.width,1.5*buttons[19].h+5),1!=t.success?(ctx.fillStyle="red",ctx.fillText(t.msg,canvas.width/2,buttons[19].y-1.5*buttons[19].h)):(ctx.fillStyle="green",ctx.fillText("Word edited!",canvas.width/2,buttons[19].y-1.5*buttons[19].h),updateWordBookWordList(!0),1==lastpage?(renderCurrentPage(1),appaused=0,-1==apinterval&&0!=autoPlay&&(apinterval=setInterval(autoPlayer,1e3*apdelay[autoPlay]))):renderCurrentPage(lastpage))},error:function(t){401==t.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}}):$.ajax({url:"/api/word/add",method:"POST",async:!0,dataType:"json",data:{word:word,translation:translation,addToWordBook:addToWordBook,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){ctx.fillStyle="white",ctx.roundRect(0,buttons[19].y-2.5*buttons[19].h,canvas.width,1.5*buttons[19].h+5),0==t.success?alert(t.msg):(ctx.fillStyle="green",ctx.fillText(t.msg,canvas.width/2,buttons[19].y-1.5*buttons[19].h),updateWordBookWordList(!0),sleep(500).then(()=>{$("#addword_word").val(""),$("#addword_translation").val(""),$("#addword_word").focus()}))},error:function(t){401==t.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}})}else if("cleardeleted"==buttons[n].name){if(2!=currentpage)return;confirm('Are you sure to delete all the words that are marked as "Deleted" permanently? This operation cannot be undone!')&&$.ajax({url:"/api/word/clearDeleted",method:"POST",async:!0,dataType:"json",data:{userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){alert("Done")},error:function(t){401==t.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}})}else if("statistics"==buttons[n].name)statson=1,statistics="[Failed to fetch statistics]",$.ajax({url:"/api/word/stat",method:"POST",async:!0,dataType:"json",data:{wordId:wordId,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){statistics=t.msg,ctx.fillStyle=getRndColor(10,100),ctx.roundRect(buttons[6].x-5,canvas.height/2-240-5,buttons[11].x-buttons[6].x+buttons[11].w+10,canvas.height-bottomOffset-(canvas.height/2-220)+50),ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[6].x,canvas.height/2-240,buttons[11].x-buttons[6].x+buttons[11].w,canvas.height-bottomOffset-(canvas.height/2-220)+40),ctx.font=smallFontSize+"px Corbel",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center";var o=statistics.split("\n");$("#hiddenSpan").attr("style","display:none;font:"+smallFontSize+"px Corbel"),$("#hiddenSpan").html("test"),lineHeight=$("#hiddenSpan").height()+5;for(var e=0;e<o.length;e++)ctx.fillText(o[e],canvas.width/2,canvas.height/2-220+e*lineHeight)},error:function(t){401==t.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}});else if("mode1"==buttons[n].name)random=1-random,localStorage.setItem("random",random),renderCurrentPage();else if("mode2"==buttons[n].name)swap=1-swap,localStorage.setItem("swap",swap),renderCurrentPage();else if("mode3"==buttons[n].name)showStatus+=1,4==showStatus&&(showStatus=1),localStorage.setItem("showStatus",showStatus),renderCurrentPage();else if("mode4"==buttons[n].name)autoPlay+=1,4==autoPlay&&(autoPlay=0),localStorage.setItem("autoPlay",autoPlay),renderCurrentPage();else if("mode0"==buttons[n].name)displayMode+=1,3==displayMode&&(displayMode=0),localStorage.setItem("displayMode",displayMode),renderCurrentPage();else if("pauseap"==buttons[n].name){if(0==autoPlay)return;appaused&&-1==apinterval?apinterval=setInterval(autoPlayer,1e3*apdelay[autoPlay]):(clearInterval(apinterval),apinterval=-1),appaused=1-appaused,renderCurrentPage()}else if("import"==buttons[n].name)window.location.href="/importData";else if("export"==buttons[n].name)window.location.href="/exportData";else if("createwordbook"==buttons[n].name)createWordBook();else if("wordbookaddword"==buttons[n].name){if(0==selected.length)return void alert("Select at least one word!");$.ajax({url:"/api/wordBook/addWord",method:"POST",async:!1,dataType:"json",data:{words:JSON.stringify(selected),wordBookId:wordBookId,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){1==t.success?(updateWordBookWordList(!0),renderCurrentPage(4)):alert(t.msg)},error:function(t){401==t.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}}),selected=[]}else if("selectwordbook"==buttons[n].name&&selectedWordBook!=wordBookId){selectedWordBook=wordBookId,localStorage.setItem("selectedWordBook",selectedWordBook);for(a=0;a<wordBookList.length;a++)if(wordBookList[a].wordBookId==selectedWordBook){selectedWordBookName=wordBookList[a].name,selectedWordList=[];for(var s=0;s<wordBookList[a].words.length;s++)wordId=wordBookList[a].words[s],wordData=wordListMap.get(wordId),selectedWordList.push({wordId:wordId,word:wordData.word,translation:wordData.translation,status:wordData.status})}renderCurrentPage()}}else msg=new SpeechSynthesisUtterance(word),speaker.speak(msg);else"tag"==buttons[n].name?2==wordStatus?wordStatus=1:1!=wordStatus&&3!=wordStatus||(wordStatus=2):"remove"==buttons[n].name&&(3==wordStatus?wordStatus=1:1!=wordStatus&&2!=wordStatus||(wordStatus=3)),$.ajax({url:"/api/word/status/update",method:"POST",async:!0,dataType:"json",data:{words:JSON.stringify([wordId]),status:wordStatus,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){ctx.fillStyle=rectcolor,ctx.roundRect(buttons[6].x,buttons[6].y,buttons[6].w,buttons[6].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=textcolor,2==wordStatus?ctx.fillText("Untag",buttons[6].x+buttons[6].w/2,buttons[6].y+buttons[6].h/1.4):ctx.fillText("Tag",buttons[6].x+buttons[6].w/2,buttons[6].y+buttons[6].h/1.4),ctx.fillStyle=rectcolor,ctx.roundRect(buttons[11].x,buttons[11].y,buttons[11].w,buttons[11].h),ctx.font=fontSize+"px Corbel",ctx.fillStyle=textcolor,3==wordStatus?(ctx.font=.9*fontSize+"px Corbel",ctx.fillText("Undelete",buttons[11].x+buttons[11].w/2,buttons[11].y+buttons[11].h/1.4)):ctx.fillText("Delete",buttons[11].x+buttons[11].w/2,buttons[11].y+buttons[11].h/1.4)},error:function(t){401==t.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}});else if(0==displayMode)moveType=0,"previous"==buttons[n].name?moveType=-1:"next"==buttons[n].name&&(moveType=1),random&&(moveType=0),displayingAnswer=0,$.ajax({url:"/api/word/next",method:"POST",async:!0,dataType:"json",data:{wordId:wordId,status:showStatus,moveType:moveType,wordBookId:selectedWordBook,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){word=t.word,translation=t.translation,wordStatus=t.status,wordId=t.wordId,renderCurrentPage()},error:function(t,o,e){401==t.status?(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user"):($("#startfrom").hide(),word=t.status+" "+e,translation="Maybe change the settings?\nOr check your connection?",renderWord(1,1))}});else if(2==displayMode){moveType=0,"previous"==buttons[n].name?moveType=-1:"next"==buttons[n].name&&(moveType=1),random&&(moveType=0),displayingAnswer=0,requiredList=[];for(var a=0;a<selectedWordList.length;a++)1!=showStatus||1!=selectedWordList[a].status&&2!=selectedWordList[a].status?2==showStatus&&2==selectedWordList[a].status?requiredList.push(selectedWordList[a]):3==showStatus&&3==selectedWordList[a].status&&requiredList.push(selectedWordList[a]):requiredList.push(selectedWordList[a]);if(0==moveType)index=parseInt(Math.random()*requiredList.length),wordId=requiredList[index].wordId,word=requiredList[index].word,translation=requiredList[index].translation,wordStatus=requiredList[index].status;else if(1==moveType||-1==moveType){index=-1;for(var a=0;a<requiredList.length;a++)if(requiredList[a].wordId==wordId){index=a;break}if(-1==index)return $("#startfrom").hide(),word="",translation="Unknown error",void renderWord(1,1);-1==moveType&&index>0||1==moveType&&index<requiredList.length-1?index+=moveType:-1==moveType&&0==index?index=requiredList.length-1:1==moveType&&index==requiredList.length-1&&(index=0),wordId=requiredList[index].wordId,word=requiredList[index].word,translation=requiredList[index].translation,wordStatus=requiredList[index].status}renderCurrentPage()}for(a=0;a<wordBookRect.length;a++)o>=wordBookRect[a].x&&o<=wordBookRect[a].x+wordBookW&&e>=wordBookRect[a].y&&e<=wordBookRect[a].y+wordBookH&&(wordBookId=wordBookList[a].wordBookId,wordBookName=wordBookList[a].name,wordBookShareCode=wordBookList[a].shareCode,groupId=wordBookList[a].groupId,isGroupOwner=wordBookList[a].isGroupOwner,groupCode=wordBookList[a].groupCode,localStorage.setItem("wordBookId",wordBookId),updateWordBookWordList(),renderCurrentPage(4));r||1!=currentpage||(0==statson?displayingAnswer=1-displayingAnswer:statson=0,0!=displayMode&&2!=displayMode||renderWord(displayingAnswer))}}function wordBookUpdateStatus(t){table=$("#wordList").DataTable(),table.clear(),table.draw(),$.ajax({url:"/api/word/status/update",method:"POST",async:!1,dataType:"json",data:{words:JSON.stringify(selected),status:t,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){updateWordBookWordList(!0),renderCurrentPage()},error:function(t){401==t.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}}),selected=[]}function wordBookAddWord(){0==wordBookId?($("#addword_word").val(""),$("#addword_translation").val(""),addToWordBook=-1,renderCurrentPage(3)):renderCurrentPage(6)}function wordBookClone(){$.ajax({url:"/api/wordBook/clone",method:"POST",async:!1,dataType:"json",data:{fromWordBook:wordBookId,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){updateWordBookList(!0,!0),alert(t.msg),renderCurrentPage()},error:function(t){401==t.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}})}function wordBookRename(){newName=prompt("Enter new word book name:",wordBookName),null!=newName&&$.ajax({url:"/api/wordBook/rename",method:"POST",async:!1,dataType:"json",data:{wordBookId:wordBookId,name:newName,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){updateWordBookList(!0,!0),renderCurrentPage(),t.success||alert(t.msg)},error:function(t){401==t.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}})}function wordBookRemoveWord(){$.ajax({url:"/api/wordBook/deleteWord",method:"POST",async:!1,dataType:"json",data:{words:JSON.stringify(selected),wordBookId:wordBookId,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){1==t.success?(updateWordBookWordList(!0),renderCurrentPage()):alert(t.msg)},error:function(t){401==t.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}})}function removeWord(){confirm("Are you sure to delete selected words from your word database? This will remove them from all word books no matter its status is default, tagged or deleted. This operation cannot be undone!")&&(table=$("#wordList").DataTable(),table.clear(),table.draw(),$.ajax({url:"/api/word/delete",method:"POST",async:!1,dataType:"json",data:{words:JSON.stringify(selected),userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){1==t.success?(updateWordBookWordList(!0),renderCurrentPage()):alert(t.msg)},error:function(t){401==t.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}}))}function wordBookDelete(){confirm("Are you sure to delete this word book? The words will not be deleted but they will no longer belong to this word book. This operation cannot be undone!")&&$.ajax({url:"/api/wordBook/delete",method:"POST",async:!1,dataType:"json",data:{wordBookId:wordBookId,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){1==t.success?(updateWordBookList(!1,!0),renderCurrentPage(5)):alert(t.msg)},error:function(t){401==t.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}})}function wordBookShare(){""==wordBookShareCode?$.ajax({url:"/api/wordBook/share",method:"POST",async:!1,dataType:"json",data:{wordBookId:wordBookId,operation:"share",userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){if(1==t.success)for(var o=0;o<wordBookList.length;o++)if(wordBookList[o].wordBookId==wordBookId){wordBookList[o].shareCode=t.shareCode,localStorage.setItem("wordBookList",JSON.stringify(wordBookList));break}1==t.success&&renderCurrentPage(),alert(t.msg)},error:function(t){401==t.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}}):$.ajax({url:"/api/wordBook/share",method:"POST",async:!1,dataType:"json",data:{wordBookId:wordBookId,operation:"unshare",userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){if(1==t.success)for(var o=0;o<wordBookList.length;o++)if(wordBookList[o].wordBookId==wordBookId){wordBookList[o].shareCode="",localStorage.setItem("wordBookList",JSON.stringify(wordBookList));break}alert(t.msg),1==t.success&&renderCurrentPage()},error:function(t){401==t.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}})}function wordBookNewWord(){addToWordBook=wordBookId,$("#addword_word").val(""),$("#addword_translation").val(""),renderCurrentPage(3)}function wordBookGroup(){if(""==groupCode){if(gname=prompt("Enter group name: "),""==gname||null==gname)return;if(gdescription=prompt("Enter group description: "),""==gdescription||null==gdescription)return;$.ajax({url:"/api/group",method:"POST",async:!1,dataType:"json",data:{wordBookId:wordBookId,name:gname,description:gdescription,operation:"create",userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){if(1==t.success)for(var o=0;o<wordBookList.length;o++)if(wordBookList[o].wordBookId==wordBookId){wordBookList[o].groupId=t.groupId,wordBookList[o].groupCode=t.groupCode,wordBookList[o].isGroupOwner=t.isGroupOwner,groupId=t.groupId,groupCode=t.groupCode,isGroupOwner=t.isGroupOwner,localStorage.setItem("wordBookList",JSON.stringify(wordBookList)),localStorage.setItem("groupId",groupId);break}alert(t.msg),1==t.success&&renderCurrentPage()},error:function(t){401==t.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}})}else confirm("Are you sure to dismiss the group? The sync will stop and members will not be able to see each others' progress. The word book will remain in their account. This operation cannot be undone!")&&$.ajax({url:"/api/group",method:"POST",async:!1,dataType:"json",data:{groupId:groupId,operation:"dismiss",userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){if(1==t.success)for(var o=0;o<wordBookList.length;o++)if(wordBookList[o].wordBookId==wordBookId){wordBookList[o].groupId=-1,wordBookList[o].groupCode="",wordBookList[o].isGroupOwner=!1,groupId=-1,groupCode="",isGroupOwner=!1,localStorage.setItem("wordBookList",JSON.stringify(wordBookList)),localStorage.setItem("groupId","-1");break}alert(t.msg),1==t.success&&renderCurrentPage()},error:function(t){401==t.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}})}function quitGroup(){$.ajax({url:"/api/group/quit",method:"POST",async:!1,dataType:"json",data:{groupId:groupId,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){if(1==t.success)for(var o=0;o<wordBookList.length;o++)if(wordBookList[o].wordBookId==wordBookId){wordBookList[o].groupId=-1,wordBookList[o].groupCode="",wordBookList[o].isGroupOwner=!1,groupId=-1,groupCode="",isGroupOwner=!1,localStorage.setItem("wordBookList",JSON.stringify(wordBookList)),localStorage.setItem("groupId","-1");break}alert(t.msg),1==t.success&&renderCurrentPage()},error:function(t){401==t.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}})}function groupCodeUpdate(t){$.ajax({url:"/api/group/code/update",method:"POST",async:!1,dataType:"json",data:{groupId:groupId,operation:t,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){if(1==t.success)for(var o=0;o<wordBookList.length;o++)if(wordBookList[o].wordBookId==wordBookId){wordBookList[o].groupCode=t.groupCode,groupCode=t.groupCode,localStorage.setItem("wordBookList",JSON.stringify(wordBookList));break}alert(t.msg),1==t.success&&renderCurrentPage()},error:function(t){401==t.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}})}function groupOperation(t){if("makeEditor"==t||"kick"==t||"transferOwnership"==t){if(0==groupMemberSelected.length)return;if("transferOwnership"==t&&groupMemberSelected.length>1)return void alert("Make sure you only selected one user!");if("transferOwnership"==t&&!confirm("Are you sure to transfer group ownership? Make sure you trust this user! You will lose administration authority after the transfer!"))return;$.ajax({url:"/api/group/manage",method:"POST",
async:!1,dataType:"json",data:{groupId:groupId,operation:t,users:JSON.stringify(groupMemberSelected),userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){1==t.success&&(renderCurrentPage(),groupMemberSelected=[]),alert(t.msg)},error:function(t){401==t.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}})}}function groupInfoUpdate(){gname=prompt("Enter group name: "),""!=gname&&null!=gname&&(gdescription=prompt("Enter group description: "),""!=gdescription&&null!=gdescription&&$.ajax({url:"/api/group/manage",method:"POST",async:!1,dataType:"json",data:{groupId:groupId,name:gname,description:gdescription,operation:"updateInfo",userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){1==t.success&&(updateGroupMember(!0),updateWordBookList(!0,!0)),alert(t.msg),1==t.success&&renderCurrentPage()},error:function(t){401==t.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}}))}var canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d"),isphone=0;/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(isphone=1);var fontSize=40,smallFontSize=20,largeFontSize=60,orgFontSize=40,orgsmallFontSize=20,orglargeFontSize=60,btnMargin=.5,bottomOffset=100,buttons=[],btncnt=26;isphone&&(fontSize=60,smallFontSize=40,largeFontSize=80,orgFontSize=60,orgsmallFontSize=40,orglargeFontSize=80,btnMargin=.2,bottomOffset=250);var windowOrgW=1536,windowOrgH=864;buttons[0]={name:"start",x:0,y:0,w:300,h:50,orgw:300,orgh:50},buttons[6]={name:"tag",x:0,y:0,w:200,h:50,orgw:200,orgh:50},buttons[11]={name:"remove",x:0,y:0,w:200,h:50,orgw:200,orgh:50},buttons[1]={name:"previous",x:0,y:0,w:200,h:50,orgw:200,orgh:50},buttons[2]={name:"next",x:0,y:0,w:200,h:50,orgw:200,orgh:50},buttons[3]={name:"sound",x:0,y:0,w:50,h:50,orgw:50,orgh:50},buttons[13]={name:"pauseap",x:0,y:0,w:200,h:50,orgw:200,orgh:50},buttons[16]={name:"challengeyes",x:0,y:0,w:200,h:50,orgw:200,orgh:50},buttons[17]={name:"challengeno",x:0,y:0,w:200,h:50,orgw:200,orgh:50},buttons[15]={name:"mode0",x:0,y:0,w:250,h:50,orgw:250,orgh:50},buttons[4]={name:"mode1",x:0,y:0,w:170,h:50,orgw:170,orgh:50},buttons[5]={name:"mode2",x:0,y:0,w:170,h:50,orgw:170,orgh:50},buttons[7]={name:"mode3",x:0,y:0,w:170,h:50,orgw:170,orgh:50},buttons[10]={name:"mode4",x:0,y:0,w:170,h:50,orgw:170,orgh:50},buttons[8]={name:"back",x:0,y:0,w:200,h:50,orgw:200,orgh:50,gohome:0},buttons[14]={name:"settings",x:0,y:0,w:200,h:50,orgw:200,orgh:50},buttons[20]={name:"account",x:0,y:0,w:200,h:50,orgw:200,orgh:50},buttons[18]={name:"statistics",x:0,y:0,w:200,h:50,orgw:200,orgh:50},buttons[22]={name:"wordbook",x:0,y:0,w:300,h:50,orgw:200,orgh:50},buttons[9]={name:"import",x:0,y:0,w:200,h:50,orgw:200,orgh:50},buttons[12]={name:"export",x:0,y:0,w:200,h:50,orgw:200,orgh:50},buttons[19]={name:"addword",x:0,y:0,w:300,h:50,orgw:300,orgh:50},buttons[21]={name:"cleardeleted",x:0,y:0,w:500,h:50,orgw:500,orgh:50},buttons[23]={name:"createwordbook",x:0,y:0,w:500,h:50,orgw:500,orgh:50},buttons[24]={name:"wordbookaddword",x:0,y:0,w:200,h:50,orgw:200,orgh:50},buttons[25]={name:"selectwordbook",x:0,y:0,w:200,h:50,orgw:200,orgh:50};var wordBookW=300,wordBookH=150,wordBookOrgW=300,wordBookOrgH=150;if(isphone)for(var i=0;i<btncnt;i++)buttons[i].w=2.5*buttons[i].orgw,buttons[i].h=2.5*buttons[i].orgw;btninit(),btnresize(),fontresize(),validateMsg=Math.random().toString(),$.ajax({url:"/ping",method:"POST",async:!0,dataType:"json",data:{msg:validateMsg},success:function(t){t.msg!=validateMsg&&alert("It seems that you or the server is not online, you may want to use offline mode!")},erorr:function(t){alert("It seems that you or the server is not online, you may want to use offline mode!"),displayMode=2,localStorage.setItem("displayMode","2")}});var random=localStorage.getItem("random");null==random&&(random=0),random=parseInt(random);var swap=localStorage.getItem("swap");null==swap&&(swap=0),swap=parseInt(swap);var showStatus=localStorage.getItem("showStatus");null==showStatus&&(showStatus=1),showStatus=parseInt(showStatus);var autoPlay=localStorage.getItem("autoPlay");null==autoPlay&&(autoPlay=0),autoPlay=parseInt(autoPlay);var apinterval=-1,appaused=1;displayMode=localStorage.getItem("displayMode"),null==displayMode&&(displayMode=0),displayMode=parseInt(displayMode);var wordId=localStorage.getItem("wordId"),selectedWordBook=localStorage.getItem("selectedWordBook");null==selectedWordBook&&(selectedWordBook=0,localStorage.setItem("selectedWordBook","0")),selectedWordBook=parseInt(selectedWordBook);var selectedWordBookName="",word="",displayId=-1,displayWord="",displayTranslation="",translation="",wordStatus=0,lastpage=0,currentpage=localStorage.getItem("currentpage");null==currentpage&&(currentpage=0,localStorage.setItem("currentpage","0")),3==currentpage&&(currentpage=0);lastpage=localStorage.getItem("lastpage");null==lastpage&&(lastpage=0,localStorage.setItem("lastpage","0"));var colldisplay="none",statson=0,speaker=window.speechSynthesis,displayingAnswer=0,challengeStatus=0,wordBookId=localStorage.getItem("wordBookId");null==wordBookId&&(wordBookId=0,localStorage.setItem("wordBookId","0")),wordBookId=parseInt(wordBookId);var wordBookName="",groupId=localStorage.getItem("groupId");null==groupId&&(groupId=-1,localStorage.setItem("groupId","-1")),groupId=parseInt(groupId);var isGroupOwner=!1,wordBookRect=[],wordBookCnt=1,wordBookShareCode="",groupCode="",wordBookList=JSON.parse(localStorage.getItem("wordBookList"));null!=wordBookList&&0!=wordBookList.length||(wordBookList=[],localStorage.setItem("wordBookList",JSON.stringify(wordBookList))),wordBookCnt=wordBookList.length;var lastWordBookListUpdate=Date.now();$("#wordList").DataTable({pagingType:"full_numbers"}),$("#wordList_length").append('&nbsp;&nbsp;|&nbsp;&nbsp;<a onClick="selectAll();" href="#">Select All</a>'),$("#wordList_length").append('&nbsp;&nbsp;|&nbsp;&nbsp;<a onClick="deselectAll();" href="#">Deselect All</a>'),$("#wordList_length").append("&nbsp;&nbsp;|&nbsp;&nbsp;Double click word to edit"),$("#wordList_wrapper").hide(),$("#wordList").show(),$("#groupMember").DataTable({pagingType:"full_numbers"}),$("#groupMember_length").append("&nbsp;&nbsp;|&nbsp;&nbsp;A word is regarded as memorized once the user passed 2 challenges in a row"),$("#groupMember_wrapper").hide(),$("#groupMember").show();var selected=[],groupMemberSelected=[],wordList=JSON.parse(localStorage.getItem("wordList")),selectedWordList=[];if(null==wordList)wordList=[],localStorage.setItem("wordList",JSON.stringify([]));else{table=$("#wordList").DataTable(),table.clear(),table.draw(),l=["","Default","Tagged","Deleted"];for(i=0;i<wordList.length;i++)table.row.add([[wordList[i].word],[wordList[i].translation],[l[wordList[i].status]]]).node().id=wordList[i].wordId;table.draw()}var wordListMap=new Map;for(i=0;i<wordList.length;i++)wordListMap.set(wordList[i].wordId,{word:wordList[i].word,translation:wordList[i].translation,status:wordList[i].status});var lstGMupdate=0,lstUpdateGroupId=-1,lastWordListUpdate=Date.now();setInterval(updateWordList,6e5),setInterval(updateWordBookList,6e5);for(i=0;i<wordBookList.length;i++)if(wordBookList[i].wordBookId==wordBookId&&(wordBookName=wordBookList[i].name,wordBookShareCode=wordBookList[i].shareCode,groupCode=wordBookList[i].groupCode,groupId=wordBookList[i].groupId,isGroupOwner=wordBookList[i].isGroupOwner),wordBookList[i].wordBookId==selectedWordBook){selectedWordBookName=wordBookList[i].name,selectedWordList=[];for(var j=0;j<wordBookList[i].words.length;j++)wordId=wordBookList[i].words[j],wordData=wordListMap.get(wordId),selectedWordList.push({wordId:wordId,word:wordData.word,translation:wordData.translation,status:wordData.status})}if(null!=wordId)if(null!=localStorage.getItem("userId")||""!=localStorage.getItem("token"))$.ajax({url:"/api/word",method:"POST",async:!1,dataType:"json",data:{wordId:wordId,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(t){word=t.word,translation=t.translation,wordStatus=t.status},error:function(t){for(var o=0;o<selectedWordList.length;o++)selectedWordList[o].wordId==wordId&&(word=selectedWordList[o].word,translation=selectedWordList[o].translation,wordStatus=selectedWordList[o].status)}});else for(i=0;i<selectedWordList.length;i++)selectedWordList[i].wordId==wordId&&(word=selectedWordList[i].word,translation=selectedWordList[i].translation,wordStatus=selectedWordList[i].status);""==word&&0!=selectedWordList.length&&(index=parseInt(Math.random()*selectedWordList.length),wordId=selectedWordList[index].wordId,word=selectedWordList[index].word,translation=selectedWordList[index].translation,wordStatus=selectedWordList[index].status,$("#startfrom").val(word)),lastInputChange=0,$("#startfrom").on("input",function(){lastInputChange=Date.now()});var randomDisplayer=setInterval(displayRandomWord,5e3),editWord=!1,editWordId=-1,addToWordBook=-1,loaded=!1;isphone||(window.onresize=renderCurrentPageResize),apdelay=[99999,8,5,3];var lastpress=Date.now();document.addEventListener("click",clickHandler,!1),$("#startfrom").on("keypress",function(t){13==t.which&&startfunc()}),$("#wordBookName").on("keypress",function(t){13==t.which&&createWordBook()}),$(document).on("keydown",function(t){if(1==currentpage){if(btnid=-1,32==t.which||13==t.which)return void clickHandler({pageX:-1,pageY:-1});37==t.which?btnid=1:39==t.which?btnid=2:46==t.which||68==t.which?btnid=11:84==t.which?btnid=6:83==t.which?btnid=3:80==t.which&&(btnid=13),-1!=btnid&&clickHandler({pageX:buttons[btnid].x+canvas.offsetLeft,pageY:buttons[btnid].y+canvas.offsetTop})}}),$("#wordList tbody").on("click","tr",function(){wid=parseInt($(this).attr("id")),$(this).hasClass("selected")?(idx=selected.indexOf(wid),idx>-1&&selected.splice(idx,1)):selected.push(wid),$(this).toggleClass("selected")}),$("#groupMember tbody").on("click","tr",function(){uid=parseInt($(this).attr("id")),$(this).hasClass("selected")?(idx=groupMemberSelected.indexOf(uid),idx>-1&&groupMemberSelected.splice(idx,1)):groupMemberSelected.push(uid),$(this).toggleClass("selected")}),$("#wordList tbody").on("dblclick","tr",function(){wid=parseInt($(this).attr("id")),console.log(wid),editWordId=wid,editWord=!0,addToWordBook=-1,renderCurrentPage(3)}),$("#canvas").dblclick(function(){1==currentpage&&0==displayMode&&(editWordId=wordId,editWord=!0,addToWordBook=-1,renderCurrentPage(3))}),$("#mngWBbtn").click(function(){$("#mngWBbtn").toggleClass("active"),"block"==colldisplay?(colldisplay="none",$("#mngWBclp").attr("style","display:"+colldisplay+";text-align:left;z-index:999;        margin-left:"+.5*buttons[0].w+";padding-bottom: 50px;        width:"+(window.innerWidth-25-buttons[0].w)+";        font-size:"+.8*smallFontSize+";font-family:Corbel;")):(colldisplay="block",$("#mngWBclp").attr("style","display:"+colldisplay+";text-align:left;z-index:999;        margin-left:"+.5*buttons[0].w+";padding-bottom: 50px;        width:"+(window.innerWidth-25-buttons[0].w)+";        font-size:"+.8*smallFontSize+";font-family:Corbel;"))}),updateWordBookWordList(!0),1==currentpage?renderCurrentPage(0):7==currentpage?renderCurrentPage(4):renderCurrentPage();