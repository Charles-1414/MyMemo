// Copyright (C) 2021 Charles All rights reserved.
// Author: @Charles-1414
// License: GNU General Public License v3.0

$("head").prepend("<style> @font-face { font-family: 'Comic Sans MS'; src: url('/static/ComicSansMS3.ttf') format('truetype'); } </style>");var canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d"),isphone=0;/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(isphone=1);var fontsize=40,smallfontsize=20,largefontsize=60,splitLine=16,btnMargin=.5,lineheight=50,bottomOffset=100,buttons=[],btncnt=23,ratio=.5;if(isphone||(ratio=1),isphone&&(fontsize/=ratio,smallfontsize/=ratio,largefontsize/=ratio,splitLine/=ratio,btnMargin=.2,lineheight=100,bottomOffset=250),buttons[0]={name:"start",x:0,y:0,w:300,h:50},buttons[6]={name:"tag",x:0,y:0,w:170,h:50},buttons[11]={name:"remove",x:0,y:0,w:170,h:50},buttons[1]={name:"previous",x:0,y:0,w:170,h:50},buttons[2]={name:"next",x:0,y:0,w:170,h:50},buttons[3]={name:"sound",x:0,y:0,w:50,h:50},buttons[13]={name:"pauseap",x:0,y:0,w:170,h:50},buttons[16]={name:"challengeyes",x:0,y:0,w:170,h:50},buttons[17]={name:"challengeno",x:0,y:0,w:170,h:50},buttons[15]={name:"mode0",x:0,y:0,w:250,h:50},buttons[4]={name:"mode1",x:0,y:0,w:170,h:50},buttons[5]={name:"mode2",x:0,y:0,w:170,h:50},buttons[7]={name:"mode3",x:0,y:0,w:170,h:50},buttons[10]={name:"mode4",x:0,y:0,w:170,h:50},buttons[8]={name:"homepage",x:0,y:0,w:170,h:50},buttons[14]={name:"settings",x:0,y:0,w:200,h:50},buttons[20]={name:"account",x:0,y:0,w:200,h:50},buttons[18]={name:"statistics",x:0,y:0,w:200,h:50},buttons[22]={name:"list",x:0,y:0,w:250,h:50},buttons[9]={name:"import",x:0,y:0,w:200,h:50},buttons[12]={name:"export",x:0,y:0,w:200,h:50},buttons[19]={name:"addword",x:0,y:0,w:300,h:50},buttons[21]={name:"cleardeleted",x:0,y:0,w:500,h:50},isphone)for(var i=0;i<btncnt;i++)buttons[i].w/=ratio,buttons[i].h/=ratio;var started=0,random=localStorage.getItem("random");null==random&&(random=0),random=parseInt(random);var swap=localStorage.getItem("swap");null==swap&&(swap=0),swap=parseInt(swap);var showStatus=localStorage.getItem("showStatus");null==showStatus&&(showStatus=1),showStatus=parseInt(showStatus);var autoPlay=localStorage.getItem("autoPlay");null==autoPlay&&(autoPlay=0),autoPlay=parseInt(autoPlay);var apinterval=-1,appaused=0;displayMode=localStorage.getItem("displayMode"),null==displayMode&&(displayMode=0),displayMode=parseInt(displayMode);var wordId=localStorage.getItem("wordId"),word="",translation="",status=0,lastpage=0,currentpage=0,statson=0,speaker=window.speechSynthesis,displayingAnswer=0,challengeStatus=0;null!=wordId&&null!=localStorage.getItem("token")&&""!=localStorage.getItem("token")&&$.ajax({url:"/api/getWord",method:"POST",async:!1,dataType:"json",data:{splitLine:splitLine,wordId:wordId,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(a){word=a.word,translation=a.translation,status=a.status},error:function(a){401==a.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}}),""==word&&null!=localStorage.getItem("token")&&""!=localStorage.getItem("token")&&$.ajax({url:"/api/getNext",method:"POST",async:!1,dataType:"json",data:{status:showStatus,moveType:0,splitLine:splitLine,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(a){wordId=a.wordId,word=a.word,translation=a.translation,status=a.status},error:function(a){401==a.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}}),lastInputChange=0;function displayRandomWord(){null!=localStorage.getItem("token")&&""!=localStorage.getItem("token")&&lastInputChange<Date.now()-1e4&&$.ajax({url:"/api/getNext",method:"POST",async:!1,dataType:"json",data:{status:showStatus,moveType:0,splitLine:splitLine,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(a){wordId=a.wordId,word=a.word,translation=a.translation,status=a.status,$("#startfrom").val(word)},error:function(a){401==a.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}})}$("#startfrom").on("input",function(){lastInputChange=Date.now()});var randomDisplayer=setInterval(displayRandomWord,5e3),wordcount=0;$.ajax({url:"/api/getWordCount",method:"POST",async:!1,dataType:"json",data:{userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(a){wordcount=a.count}}),wordList=[],$.ajax({url:"/api/getWordList",method:"POST",async:!0,dataType:"json",data:{userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(a){wordList=a,l=["","Default","Tagged","Deleted"],table=$("#wordList").DataTable();for(var b=0;b<wordList.length;b++)table.row.add([[wordList[b].word],[wordList[b].translation],[l[wordList[b].status]]]);table.draw()},error:function(a){401==a.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}});function btninit(){for(var a=0;a<btncnt;a++)buttons[a].x=canvas.width+5e3,buttons[a].y=canvas.height+5e3}function drawHomePage(){btninit(),$("#wordList_wrapper").hide(),canvas.width=window.innerWidth,canvas.height=window.innerHeight,ctx.clearRect(0,0,canvas.width,canvas.height),ctx.font=largefontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center",ctx.fillText("Word Memo",canvas.width/2,canvas.height/2-100),buttons[0].x=canvas.width/2-buttons[0].w/2,buttons[0].y=canvas.height/2+buttons[0].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[0].x,buttons[0].y,buttons[0].w,buttons[0].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center",ctx.fillText("Start",buttons[0].x+buttons[0].w/2,buttons[0].y+buttons[0].h/1.4),0==displayMode?ctx.fillText("Practice Mode",buttons[0].x+buttons[0].w/2,buttons[0].y+2.2*buttons[0].h):1==displayMode&&ctx.fillText("Challenge Mode",buttons[0].x+buttons[0].w/2,buttons[0].y+2.2*buttons[0].h),buttons[20].x=canvas.width-1.2*buttons[20].w,buttons[20].y=.2*buttons[20].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[20].x,buttons[20].y,buttons[20].w,buttons[20].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Account",buttons[20].x+buttons[20].w/2,buttons[20].y+buttons[20].h/1.4),buttons[14].x=canvas.width-1.2*buttons[14].w,buttons[14].y=1.5*buttons[14].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[14].x,buttons[14].y,buttons[14].w,buttons[14].h),ctx.font=.9*fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center",ctx.fillText("Settings",buttons[14].x+buttons[14].w/2,buttons[14].y+buttons[14].h/1.4),buttons[22].x=.2*buttons[22].w,buttons[22].y=.2*buttons[22].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[22].x,buttons[22].y,buttons[22].w,buttons[22].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center",ctx.fillText("Word List",buttons[22].x+buttons[22].w/2,buttons[22].y+buttons[22].h/1.4),$("#startfrom").attr("style","position:absolute;left:"+(buttons[0].x+15)+";top:"+(buttons[0].y-buttons[0].h-20)+";height:"+buttons[0].h+";width:"+(buttons[0].w-14)+";font-size:"+.6*fontsize+";font-family:Comic Sans MS"),1==displayMode?$("#startfrom").attr("disabled","disabled"):$("#startfrom").removeAttr("disabled"),-1==randomDisplayer&&(randomDisplayer=setInterval(displayRandomWord,5e3))}function drawSettings(){-1!=randomDisplayer&&(clearInterval(randomDisplayer),randomDisplayer=-1),$("#startfrom").val(""),$("#startfrom").hide(),$("#addword_word").val(""),$("#addword_word").hide(),$("#addword_translation").val(""),$("#addword_translation").hide(),btninit(),canvas.width=window.innerWidth,canvas.height=window.innerHeight,ctx.clearRect(0,0,canvas.width,canvas.height),buttons[15].x=canvas.width/2+buttons[15].w/2.5,buttons[15].y=2*buttons[15].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[15].x,buttons[15].y,buttons[15].w,buttons[15].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center",ctx.fillText("Mode:",buttons[15].x-.7*buttons[15].w,buttons[15].y+buttons[15].h/1.4),l=["Practice","Challenge"],ctx.fillText(l[displayMode],buttons[15].x+buttons[15].w/2,buttons[15].y+buttons[15].h/1.4),0==displayMode?(buttons[4].x=canvas.width/2+buttons[4].w/1.2,buttons[4].y=3.5*buttons[4].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[4].x,buttons[4].y,buttons[4].w,buttons[4].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center",ctx.fillText("Display order: ",buttons[4].x-1.2*buttons[4].w,buttons[4].y+buttons[4].h/1.4),l=["Sequence","Random"],ctx.fillText(l[random],buttons[4].x+buttons[4].w/2,buttons[4].y+buttons[4].h/1.4),buttons[5].x=canvas.width/2+buttons[5].w/1.2,buttons[5].y=5*buttons[5].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[5].x,buttons[5].y,buttons[5].w,buttons[5].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center",ctx.fillText("Swap word & translation? ",buttons[5].x-1.2*buttons[5].w,buttons[5].y+buttons[5].h/1.4),l=["No","Yes"],ctx.fillText(l[swap],buttons[5].x+buttons[5].w/2,buttons[5].y+buttons[5].h/1.4),buttons[7].x=canvas.width/2+buttons[7].w/1.2,buttons[7].y=6.5*buttons[7].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[7].x,buttons[7].y,buttons[7].w,buttons[7].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center",ctx.fillText("What to show? ",buttons[7].x-1.2*buttons[7].w,buttons[7].y+buttons[7].h/1.4),l=["","All","Tagged","Deleted"],ctx.fillText(l[showStatus],buttons[7].x+buttons[7].w/2,buttons[7].y+buttons[7].h/1.4),buttons[10].x=canvas.width/2+buttons[10].w/1.2,buttons[10].y=8*buttons[10].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[10].x,buttons[10].y,buttons[10].w,buttons[10].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center",ctx.fillText("Auto play:",buttons[10].x-1.2*buttons[10].w,buttons[10].y+buttons[10].h/1.4),l=["Disabled","Slow","Medium","Fast"],ctx.fillText(l[autoPlay],buttons[10].x+buttons[10].w/2,buttons[10].y+buttons[10].h/1.4)):1==displayMode&&(x=canvas.width/2+buttons[4].w/1.2,y=3.5*buttons[4].h,ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center",ctx.fillText("Display order: ",x-1.2*buttons[4].w,y+buttons[4].h/1.4),ctx.fillText("Random",x+buttons[4].w/2,y+buttons[4].h/1.4),buttons[5].x=canvas.width/2+buttons[5].w/1.2,buttons[5].y=5*buttons[5].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[5].x,buttons[5].y,buttons[5].w,buttons[5].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center",ctx.fillText("Swap word & translation? ",buttons[5].x-1.2*buttons[5].w,buttons[5].y+buttons[5].h/1.4),l=["No","Yes"],ctx.fillText(l[swap],buttons[5].x+buttons[5].w/2,buttons[5].y+buttons[5].h/1.4),x=canvas.width/2+buttons[7].w/1.2,y=6.5*buttons[7].h,ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center",ctx.fillText("What to show? ",x-1.2*buttons[7].w,y+buttons[7].h/1.4),ctx.fillText("Everything",x+buttons[7].w/2,y+buttons[7].h/1.4),x=canvas.width/2+buttons[10].w/1.2,y=8*buttons[10].h,ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center",ctx.fillText("Auto play:",x-1.2*buttons[10].w,y+buttons[10].h/1.4),ctx.fillText("Disabled",x+buttons[10].w/2,y+buttons[10].h/1.4)),buttons[19].x=canvas.width/2-buttons[19].w/2,buttons[19].y=canvas.height-4*buttons[19].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[19].x,buttons[19].y,buttons[19].w,buttons[19].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center",ctx.fillText("Add Word",buttons[19].x+buttons[19].w/2,buttons[19].y+buttons[19].h/1.4),buttons[21].x=canvas.width/2-buttons[21].w/2,buttons[21].y=canvas.height-2.5*buttons[21].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[21].x,buttons[21].y,buttons[21].w,buttons[21].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center",ctx.fillText("Clear deleted words",buttons[21].x+buttons[21].w/2,buttons[21].y+buttons[21].h/1.4),buttons[9].x=canvas.width/2-buttons[9].w*(1+.6*btnMargin),buttons[9].y=canvas.height-1.2*buttons[9].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[9].x,buttons[9].y,buttons[9].w,buttons[9].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center",ctx.fillText("Import",buttons[9].x+buttons[9].w/2,buttons[9].y+buttons[9].h/1.4),buttons[12].x=canvas.width/2+.6*(buttons[12].w*btnMargin),buttons[12].y=canvas.height-1.2*buttons[12].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[12].x,buttons[12].y,buttons[12].w,buttons[12].h),ctx.font=.9*fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center",ctx.fillText("Export",buttons[12].x+buttons[12].w/2,buttons[12].y+buttons[12].h/1.4),1==lastpage?1==lastpage&&(buttons[0].x=.2*buttons[8].w,buttons[0].y=.2*buttons[8].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[0].x,buttons[0].y,buttons[8].w,buttons[8].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center",ctx.fillText("Resume",buttons[0].x+buttons[8].w/2,buttons[0].y+buttons[8].h/1.4)):(buttons[8].x=.2*buttons[8].w,buttons[8].y=.2*buttons[8].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[8].x,buttons[8].y,buttons[8].w,buttons[8].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center",ctx.fillText("Home",buttons[8].x+buttons[8].w/2,buttons[8].y+buttons[8].h/1.4)),ctx.fillText("Settings",canvas.width/2,.2*buttons[8].h+buttons[8].h/1.4)}function drawAddWord(){canvas.width=window.innerWidth,canvas.height=window.innerHeight,ctx.clearRect(0,0,canvas.width,canvas.height),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center",ctx.fillText("Word: ",canvas.width/2-buttons[0].w/2,canvas.height/2-100),$("#addword_word").attr("style","position:absolute;left:"+canvas.width/2+";top:"+(canvas.height/2-118)+";font-size:"+.4*fontsize+";font-family:Comic Sans MS"),ctx.fillText("Translation: ",canvas.width/2-buttons[0].w/2,canvas.height/2-50),$("#addword_translation").attr("style","position:absolute;left:"+canvas.width/2+";top:"+(canvas.height/2-68)+";font-size:"+.4*fontsize+";font-family:Comic Sans MS"),buttons[14].x=canvas.width-1.2*buttons[14].w,buttons[14].y=.2*buttons[14].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[14].x,buttons[14].y,buttons[14].w,buttons[14].h),ctx.font=.9*fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center",ctx.fillText("Settings",buttons[14].x+buttons[14].w/2,buttons[14].y+buttons[14].h/1.4),buttons[19].x=canvas.width/2-buttons[19].w/2,buttons[19].y=canvas.height-3*buttons[19].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[19].x,buttons[19].y,buttons[19].w,buttons[19].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center",ctx.fillText("Add",buttons[19].x+buttons[19].w/2,buttons[19].y+buttons[19].h/1.4),ctx.fillText("Add Word",canvas.width/2,.2*buttons[8].h+buttons[8].h/1.4)}function drawWord(a=0,b=0){if(-1!=randomDisplayer&&(clearInterval(randomDisplayer),randomDisplayer=-1),btninit(),canvas.width=window.innerWidth,canvas.height=window.innerHeight,ctx.clearRect(0,0,canvas.width,canvas.height),localStorage.setItem("wordId",wordId),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle="#000000",ctx.textAlign="center",(0==swap||1==swap&&1==a||1==swap&&1==challengeStatus||1==swap&&3==challengeStatus||1==displayMode&&-1==wordId)&&ctx.fillText(word,canvas.width/2,canvas.height/2-200),1==swap||0==swap&&1==a||0==swap&&1==challengeStatus||0==swap&&3==challengeStatus||1==displayMode&&-1==wordId)for(var c=translation.split("\n"),d=0;d<c.length;d++)ctx.fillText(c[d],canvas.width/2,canvas.height/2-100+d*lineheight);$("#startfrom").val(word),blockcolor=getRndColor(160,250),textcolor=getRndColor(10,100),(0==swap||1==swap&&1==a||1==displayMode&&0<challengeStatus)&&-1!=wordId&&(buttons[3].x=canvas.width/2-buttons[3].w/2,buttons[3].y=canvas.height-bottomOffset,ctx.fillStyle=blockcolor,ctx.roundRect(buttons[3].x,buttons[3].y,buttons[3].w,buttons[3].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=textcolor,ctx.fillText("\uD83D\uDD08",buttons[3].x+buttons[3].w/2,buttons[3].y+buttons[3].h/1.4)),0==displayMode?(ctx.fillText("Practice Mode",canvas.width/2,.2*buttons[0].h+buttons[0].h/1.4),buttons[1].x=canvas.width/2-buttons[1].w*(1+btnMargin),buttons[1].y=canvas.height-bottomOffset,ctx.fillStyle=blockcolor,ctx.roundRect(buttons[1].x,buttons[1].y,buttons[1].w,buttons[1].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=textcolor,ctx.fillText("Previous",buttons[1].x+buttons[1].w/2,buttons[1].y+buttons[1].h/1.4),buttons[2].x=canvas.width/2+buttons[2].w*btnMargin,buttons[2].y=canvas.height-bottomOffset,ctx.fillStyle=blockcolor,ctx.roundRect(buttons[2].x,buttons[2].y,buttons[2].w,buttons[2].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=textcolor,ctx.fillText("Next",buttons[2].x+buttons[2].w/2,buttons[2].y+buttons[2].h/1.4),buttons[6].x=canvas.width/2-buttons[6].w*(1+btnMargin),buttons[6].y=canvas.height-bottomOffset-1.5*buttons[6].h,ctx.fillStyle=blockcolor,ctx.roundRect(buttons[6].x,buttons[6].y,buttons[6].w,buttons[6].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=textcolor,2==status?ctx.fillText("Untag",buttons[6].x+buttons[6].w/2,buttons[6].y+buttons[6].h/1.4):ctx.fillText("Tag",buttons[6].x+buttons[6].w/2,buttons[6].y+buttons[6].h/1.4),buttons[11].x=canvas.width/2+buttons[11].w*btnMargin,buttons[11].y=canvas.height-bottomOffset-1.5*buttons[11].h,ctx.fillStyle=blockcolor,ctx.roundRect(buttons[11].x,buttons[11].y,buttons[11].w,buttons[11].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=textcolor,3==status?(ctx.font=.9*fontsize+"px Comic Sans MS",ctx.fillText("Undelete",buttons[11].x+buttons[11].w/2,buttons[11].y+buttons[11].h/1.4)):ctx.fillText("Delete",buttons[11].x+buttons[11].w/2,buttons[11].y+buttons[11].h/1.4)):1==displayMode&&(ctx.fillText("Challenge Mode",canvas.width/2,.2*buttons[0].h+buttons[0].h/1.4),-1!=wordId&&(3!=challengeStatus&&(buttons[16].x=canvas.width/2-buttons[16].w*(1+btnMargin),buttons[16].y=canvas.height-bottomOffset-1.5*buttons[16].h,ctx.fillStyle=blockcolor,ctx.roundRect(buttons[16].x,buttons[16].y,buttons[16].w,buttons[16].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=textcolor,ctx.fillText("Yes",buttons[16].x+buttons[16].w/2,buttons[16].y+buttons[16].h/1.4)),0==challengeStatus?ctx.fillText("Do you remember it?",buttons[16].x+1.5*buttons[16].w,buttons[16].y-buttons[16].h/1.4):1==challengeStatus?ctx.fillText("Are you correct?",buttons[16].x+1.6*buttons[16].w,buttons[16].y-buttons[16].h/1.4):3==challengeStatus&&(x=canvas.width/2-buttons[16].w*(1+btnMargin),y=canvas.height-bottomOffset-1.5*buttons[16].h,ctx.fillText("Try to memorize it!",x+1.5*buttons[16].w,y-buttons[16].h/1.4)),buttons[17].x=canvas.width/2+buttons[17].w*btnMargin,buttons[17].y=canvas.height-bottomOffset-1.5*buttons[17].h,ctx.fillStyle=blockcolor,ctx.roundRect(buttons[17].x,buttons[17].y,buttons[17].w,buttons[17].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=textcolor,3==challengeStatus?ctx.fillText("Next",buttons[17].x+buttons[17].w/2,buttons[17].y+buttons[17].h/1.4):ctx.fillText("No",buttons[17].x+buttons[17].w/2,buttons[17].y+buttons[17].h/1.4),buttons[6].x=canvas.width/2-buttons[6].w*(1+btnMargin),buttons[6].y=canvas.height-bottomOffset,ctx.fillStyle=blockcolor,ctx.roundRect(buttons[6].x,buttons[6].y,buttons[6].w,buttons[6].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=textcolor,2==status?ctx.fillText("Untag",buttons[6].x+buttons[6].w/2,buttons[6].y+buttons[6].h/1.4):ctx.fillText("Tag",buttons[6].x+buttons[6].w/2,buttons[6].y+buttons[6].h/1.4),buttons[11].x=canvas.width/2+buttons[11].w*btnMargin,buttons[11].y=canvas.height-bottomOffset,ctx.fillStyle=blockcolor,ctx.roundRect(buttons[11].x,buttons[11].y,buttons[11].w,buttons[11].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=textcolor,3==status?(ctx.font=.9*fontsize+"px Comic Sans MS",ctx.fillText("Undelete",buttons[11].x+buttons[11].w/2,buttons[11].y+buttons[11].h/1.4)):ctx.fillText("Delete",buttons[11].x+buttons[11].w/2,buttons[11].y+buttons[11].h/1.4))),0!=autoPlay&&(buttons[13].x=canvas.width/2-buttons[13].w*(1+btnMargin),buttons[13].y=canvas.height-bottomOffset-3*buttons[13].h,ctx.fillStyle=blockcolor,ctx.roundRect(buttons[13].x,buttons[13].y,buttons[13].w,buttons[13].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=textcolor,appaused?ctx.fillText("Play",buttons[13].x+buttons[13].w/2,buttons[13].y+buttons[13].h/1.4):ctx.fillText("Pause",buttons[13].x+buttons[13].w/2,buttons[13].y+buttons[13].h/1.4)),0==autoPlay||appaused||b||0!=swap||(speaker.cancel(),msg=new SpeechSynthesisUtterance(word),speaker.speak(msg)),buttons[18].x=canvas.width-1.2*buttons[18].w,buttons[18].y=1.5*buttons[18].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[18].x,buttons[18].y,buttons[18].w,buttons[18].h),ctx.font=.9*fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center",ctx.fillText("Statistics",buttons[18].x+buttons[18].w/2,buttons[18].y+buttons[18].h/1.4),buttons[8].x=.2*buttons[8].w,buttons[8].y=.2*buttons[8].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[8].x,buttons[8].y,buttons[8].w,buttons[8].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.fillText("Home",buttons[8].x+buttons[8].w/2,buttons[8].y+buttons[8].h/1.4),buttons[14].x=canvas.width-1.2*buttons[14].w,buttons[14].y=.2*buttons[14].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[14].x,buttons[14].y,buttons[14].w,buttons[14].h),ctx.font=.9*fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center",ctx.fillText("Settings",buttons[14].x+buttons[14].w/2,buttons[14].y+buttons[14].h/1.4),lastpage=1}function drawWordList(){btninit(),canvas.width=window.innerWidth,canvas.height=window.innerHeight,ctx.clearRect(0,0,canvas.width,canvas.height),$("#startfrom").hide(),buttons[8].x=.2*buttons[8].w,buttons[8].y=.2*buttons[8].h,ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[8].x,buttons[8].y,buttons[8].w,buttons[8].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center",ctx.fillText("Home",buttons[8].x+buttons[8].w/2,buttons[8].y+buttons[8].h/1.4),$("#wordList_wrapper").show(),$("#wordList").show(),$("#wordList_wrapper").attr("style","test-align:center;position:absolute;left:"+(canvas.width/2-500/ratio)+";top:"+(buttons[8].x+buttons[8].h)+";height:"+500/ratio+";width:"+1e3/ratio+";font-size:"+.6*fontsize+";font-family:Comic Sans MS"),ctx.fillText("Word List",canvas.width/2,.2*buttons[8].h+buttons[8].h/1.4)}function drawCurrentPage(){sleep(50).then(()=>{0==currentpage?drawHomePage():1==currentpage?drawWord():2==currentpage?drawSettings():3==currentpage?drawAddWord():4==currentpage&&drawWordList()})}isphone||(window.onresize=drawCurrentPage),apdelay=[99999,8,5,3];function autoPlayer(){console.log("auto player running"),moveType=1-random,$.ajax({url:"/api/getNext",method:"POST",async:!0,dataType:"json",data:{wordId:wordId,splitLine:splitLine,status:showStatus,moveType:moveType,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(a){word=a.word,translation=a.translation,status=a.status,wordId=a.wordId,displayingAnswer=0,drawWord()},error:function(a,b,c){401==a.status?(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user"):(word=a.status+" "+c,translation="Maybe change the settings?\nOr check your connection?",drawWord(1,1))}})}function startfunc(){0==displayMode?""==$("#startfrom").val()?$.ajax({url:"/api/getNext",method:"POST",async:!1,dataType:"json",data:{status:showStatus,moveType:0,splitLine:splitLine,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(a){lastpage=currentpage,currentpage=1,wordId=a.wordId,started=1,btninit(),$("#startfrom").hide(),$("#startfrom").val(""),word=a.word,translation=a.translation,status=a.status,drawWord()},error:function(a){401==a.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}}):(startword=$("#startfrom").val(),$.ajax({url:"/api/getWordId",method:"POST",async:!1,dataType:"json",data:{word:startword,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(a){lastpage=currentpage,currentpage=1,wordId=a.wordId,started=1,btninit(),$("#startfrom").hide(),$("#startfrom").val(""),$.ajax({url:"/api/getWord",method:"POST",async:!1,dataType:"json",data:{splitLine:splitLine,wordId:wordId,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(a){word=a.word,translation=a.translation,status=a.status,wordId=a.wordId,drawWord()},error:function(a){401==a.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}}),-1==apinterval&&0!=autoPlay&&(apinterval=setInterval(autoPlayer,1e3*apdelay[autoPlay]))},error:function(a){404==a.status?$("#startfrom").val("Not found!"):401==a.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}})):1==displayMode&&(started=1,lastpage=currentpage,currentpage=1,$.ajax({url:"/api/getNextChallenge",method:"POST",async:!1,dataType:"json",data:{splitLine:splitLine,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(a){$("#startfrom").hide(),word=a.word,$("#startfrom").val(word),translation=a.translation,status=a.status,wordId=a.wordId,btninit(),drawWord()},error:function(a){401==a.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}}))}function clickHandler(a){for(var b=a.clientX-canvas.offsetLeft,c=a.clientY-canvas.offsetTop,d=0,e=0;e<btncnt;e++)if(b>=buttons[e].x&&b<=buttons[e].x+buttons[e].w&&c>=buttons[e].y&&c<=buttons[e].y+buttons[e].h)if(d=1,console.log(buttons[e].name+" button triggered"),"start"==buttons[e].name)sleep(50).then(()=>{startfunc()});else if(started&&("previous"==buttons[e].name||"next"==buttons[e].name))t=wordId,random&&(t=Math.floor(wordcount*Math.random())),moveType=0,"previous"==buttons[e].name?moveType=-1:"next"==buttons[e].name&&(moveType=1),displayingAnswer=0,$.ajax({url:"/api/getNext",method:"POST",async:!0,dataType:"json",data:{wordId:t,status:showStatus,moveType:moveType,splitLine:splitLine,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(a){word=a.word,translation=a.translation,status=a.status,wordId=a.wordId,drawWord()},error:function(a,b,c){401==a.status?(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user"):(word=a.status+" "+c,translation="Maybe change the settings?\nOr check your connection?",drawWord(1,1))}});else if(started&&("tag"==buttons[e].name||"remove"==buttons[e].name))"tag"==buttons[e].name?2==status?status=1:(1==status||3==status)&&(status=2):"remove"==buttons[e].name&&(3==status?status=1:(1==status||2==status)&&(status=3)),$.ajax({url:"/api/updateWordStatus",method:"POST",async:!0,dataType:"json",data:{wordId:wordId,status:status,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(){ctx.fillStyle=blockcolor,ctx.roundRect(buttons[6].x,buttons[6].y,buttons[6].w,buttons[6].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=textcolor,2==status?ctx.fillText("Untag",buttons[6].x+buttons[6].w/2,buttons[6].y+buttons[6].h/1.4):ctx.fillText("Tag",buttons[6].x+buttons[6].w/2,buttons[6].y+buttons[6].h/1.4),ctx.fillStyle=blockcolor,ctx.roundRect(buttons[11].x,buttons[11].y,buttons[11].w,buttons[11].h),ctx.font=fontsize+"px Comic Sans MS",ctx.fillStyle=textcolor,3==status?(ctx.font=.9*fontsize+"px Comic Sans MS",ctx.fillText("Undelete",buttons[11].x+buttons[11].w/2,buttons[11].y+buttons[11].h/1.4)):ctx.fillText("Delete",buttons[11].x+buttons[11].w/2,buttons[11].y+buttons[11].h/1.4)},error:function(a){401==a.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}});else if(started&&"sound"==buttons[e].name&&!speaker.speaking)msg=new SpeechSynthesisUtterance(word),speaker.speak(msg);else if("challengeyes"==buttons[e].name)0==challengeStatus?(challengeStatus=1,drawWord()):1==challengeStatus&&$.ajax({url:"/api/updateChallengeRecord",method:"POST",async:!0,dataType:"json",data:{wordId:wordId,memorized:1,getNext:1,splitLine:splitLine,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(a){challengeStatus=0,word=a.word,translation=a.translation,status=a.status,wordId=a.wordId,drawWord()},error:function(a){401==a.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}});else if("challengeno"==buttons[e].name)0==challengeStatus||1==challengeStatus?(challengeStatus=3,$.ajax({url:"/api/updateChallengeRecord",method:"POST",async:!0,dataType:"json",data:{wordId:wordId,memorized:0,getNext:0,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")}}),drawWord()):3==challengeStatus&&$.ajax({url:"/api/getNextChallenge",method:"POST",async:!0,dataType:"json",data:{splitLine:splitLine,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(a){challengeStatus=0,word=a.word,translation=a.translation,status=a.status,wordId=a.wordId,drawWord()},error:function(a){401==a.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}});else if("homepage"==buttons[e].name)lastpage=currentpage,currentpage=0,started=0,appaused=0,clearInterval(apinterval),apinterval=-1,speaker.cancel(),sleep(50).then(()=>{drawCurrentPage()});else if("settings"==buttons[e].name)lastpage=currentpage,currentpage=2,started=0,appaused=0,clearInterval(apinterval),apinterval=-1,speaker.cancel(),sleep(50).then(()=>{drawCurrentPage()});else if("list"==buttons[e].name)lastpage=currentpage,currentpage=4,started=0,appaused=0,clearInterval(apinterval),apinterval=-1,speaker.cancel(),sleep(50).then(()=>{drawCurrentPage()});else if("account"==buttons[e].name)window.location.href="/user";else if("addword"!=buttons[e].name)"cleardeleted"==buttons[e].name?confirm("Are you sure to delete all the words that are marked as \"Deleted\" permanently? This operation cannot be undone!")?$.ajax({url:"/api/clearDeleted",method:"POST",async:!0,dataType:"json",data:{userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(){alert("Done")},error:function(a){401==a.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}}):alert("Canceled"):"statistics"==buttons[e].name?(statson=1,statistics="[Failed to fetch statistics]",$.ajax({url:"/api/getWordStat",method:"POST",async:!0,dataType:"json",data:{wordId:wordId,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(a){statistics=a.msg,ctx.fillStyle=getRndColor(10,100),ctx.roundRect(buttons[6].x-5,canvas.height/2-240-5,buttons[11].x-buttons[6].x+buttons[11].w+10,canvas.height-bottomOffset-(canvas.height/2-220)+50),ctx.fillStyle=getRndColor(160,250),ctx.roundRect(buttons[6].x,canvas.height/2-240,buttons[11].x-buttons[6].x+buttons[11].w,canvas.height-bottomOffset-(canvas.height/2-220)+40),ctx.font=smallfontsize+"px Comic Sans MS",ctx.fillStyle=getRndColor(10,100),ctx.textAlign="center";for(var b=statistics.split("\n"),c=smallfontsize+5,d=0;d<b.length;d++)ctx.fillText(b[d],canvas.width/2,canvas.height/2-220+d*c)},error:function(a){401==a.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}})):"mode1"==buttons[e].name?(random=1-random,localStorage.setItem("random",random),drawCurrentPage()):"mode2"==buttons[e].name?(swap=1-swap,localStorage.setItem("swap",swap),drawCurrentPage()):"mode3"==buttons[e].name?(showStatus+=1,4==showStatus&&(showStatus=1),localStorage.setItem("showStatus",showStatus),drawCurrentPage()):"mode4"==buttons[e].name?(autoPlay+=1,4==autoPlay&&(autoPlay=0),localStorage.setItem("autoPlay",autoPlay),drawCurrentPage()):"mode0"==buttons[e].name?(displayMode=1-displayMode,localStorage.setItem("displayMode",displayMode),drawCurrentPage()):"pauseap"==buttons[e].name?(appaused&&-1==apinterval?apinterval=setInterval(autoPlayer,1e3*apdelay[autoPlay]):(clearInterval(apinterval),apinterval=-1),appaused=1-appaused,drawWord()):"import"==buttons[e].name?window.location.href="/importData":"export"==buttons[e].name&&(window.location.href="/exportData");else if(3==currentpage){if(ctx.font=fontsize+"px Comic Sans MS",ctx.textAlign="center",word=$("#addword_word").val(),translation=$("#addword_translation").val(),""==word||""==translation)return ctx.fillStyle="white",ctx.roundRect(0,buttons[19].y-2.5*buttons[19].h,canvas.width,1.5*buttons[19].h+5),ctx.fillStyle="red",void ctx.fillText("Both fields must be filled!",canvas.width/2,buttons[19].y-1.5*buttons[19].h);ctx.fillStyle="white",ctx.roundRect(0,buttons[19].y-2.5*buttons[19].h,canvas.width,1.5*buttons[19].h+5),ctx.fillStyle="blue",ctx.fillText("Submitting...",canvas.width/2,buttons[19].y-1.5*buttons[19].h),$.ajax({url:"/api/addWord",method:"POST",async:!0,dataType:"json",data:{word:word,translation:translation,userId:localStorage.getItem("userId"),token:localStorage.getItem("token")},success:function(a){ctx.fillStyle="white",ctx.roundRect(0,buttons[19].y-2.5*buttons[19].h,canvas.width,1.5*buttons[19].h+5),!0==a.duplicate?(ctx.fillStyle="red",ctx.fillText("Word duplicated! Add again to ignore.",canvas.width/2,buttons[19].y-1.5*buttons[19].h)):(ctx.fillStyle="green",ctx.fillText("Word added!",canvas.width/2,buttons[19].y-1.5*buttons[19].h))},error:function(a){401==a.status&&(alert("Login session expired! Please login again!"),localStorage.removeItem("userId"),localStorage.removeItem("token"),window.location.href="/user")}})}else 2==currentpage&&(lastpage=currentpage,currentpage=3,$("#addword_word").val(""),$("#addword_translation").val(""),drawCurrentPage());!d&&started&&(0==statson?displayingAnswer=1-displayingAnswer:statson=0,0==displayMode&&drawWord(displayingAnswer))}$("#startfrom").on("keypress",function(a){13==a.which&&startfunc()}),document.addEventListener("click",clickHandler,!1),$("#wordList").DataTable({pagingType:"full_numbers"}),$("#wordList_wrapper").hide(),drawHomePage();